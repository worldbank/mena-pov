---
title: 'World Bank Vulnerability Mapping Project: Index'
author: 'Liang Cai'
date: '2021/7/25'
output: html_document
---
#Set up common path
```{r setup, include=FALSE}
rm(list=ls())

#Define relative path
knitr::opts_knit$set(root.dir = '/Users/ashitakarl/Dropbox/WB/MENA_WorldBank/')
```

#Load libraries
```{r}
library(BBmisc)
library(ggplot2)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(classInt)
library(ggrepel)
library(viridis)
```

#Define data directories
```{r}
dir_shp <- './Boundaries/'                                                                   #Confirm path
dir_in <- './Index/ADM2/Input/'                                                              #Confirm path
dir_out <- './Index/ADM2/'                                                                   #Confirm path
dir_fig <- './Index/ADM2/Maps/'                                                              #Confirm path
dir_ras <- '/Users/ashitakarl/Desktop/Project/WB/MENA/Vectorized/'                               #Confirm path
```

# Load shapefile
```{r shp}
#set CRS of shapefiles to WGS84
CRS_uni <- '+proj=longlat +datum=WGS84 +no_defs'

# Load the shapefile of the country
shape <- read_sf(paste0(dir_shp, 'MENA_ADM2.shp')) %>%                            #Change filename  
  st_transform(CRS_uni) %>%
  st_make_valid() %>%
  # The Number of districts
  mutate(ID = seq.int(1, n()),
         area_sqkm = st_area(.) / 1000000,
         ID_ADM = as.numeric(ID_ADM))

shape_0 <- read_sf(paste0(dir_shp, 'MENA_Country.shp')) %>%                            #Change filename  
  st_transform(CRS_uni) %>%
  st_make_valid() 
```

#Merge all indices together in on Data Frame
```{r merge, eval = F}
#Get all the index in the input folder. Call in all the csv files.
#run together
temp <- list.files(path= dir_in, pattern = '*.csv')
file_names <- make.names(gsub('*.csv$', '', temp))
list2env(
  lapply(setNames(paste0(dir_in, temp), file_names),
         read_csv), envir = .GlobalEnv)

# Connectivity
#Road density
road <- ADM2_ROAD %>%
  dplyr::select(c(ID_ADM, road_den)) %>%
  rename(road_raw = road_den)

# Friction
friction <- ADM2_FRICTION_2019 %>%
  dplyr::select(c(ID_ADM, FRICTION_mean_2019))

# Disasters
#Floods
flood <- ADM2_FLOOD_1995_2020 %>%
  dplyr::select(c(ID_ADM, year, N_Flood)) %>%
  rename(flood_raw = N_Flood) %>%
  mutate(year_range = ifelse(year <= 2000, 'FLOOD_1995_2000',
                             ifelse(year <= 2005, 'FLOOD_2001_2005',
                                    ifelse(year <= 2010, 'FLOOD_2006_2010',
                                           ifelse(year <= 2015, 'FLOOD_2011_2015',
                                                  ifelse(year <= 2020, 'FLOOD_2016_2020')))))) %>%
  group_by(ID_ADM, year_range) %>%
  summarise(n = sum(flood_raw)) %>%
  pivot_wider(names_from = year_range, values_from = n) %>%
  replace(is.na(.), 0)

#Earthquake
earthquake <- ADM2_QUAKE_1995_2020 %>%
  dplyr::select(c(ID_ADM, year, N_Quake)) %>%
  rename(quake_raw = N_Quake) %>%
  mutate(year_range = ifelse(year <= 2000, 'QUAKE_1995_2000',
                             ifelse(year <= 2005, 'QUAKE_2001_2005',
                                    ifelse(year <= 2010, 'QUAKE_2006_2010',
                                           ifelse(year <= 2015, 'QUAKE_2011_2015',
                                                  ifelse(year <= 2020, 'QUAKE_2016_2020')))))) %>%
  group_by(ID_ADM, year_range) %>%
  summarise(n = sum(quake_raw)) %>%
  pivot_wider(names_from = year_range, values_from = n) %>%
  replace(is.na(.), 0)

drought <- ADM2_CDI_2001_2020

# Climate
#prep precipitation data
precipitation <- ADM2_PRECIP_2001_2020

#prep temperature data
temperature <- ADM2_TEMP_2000_2020 

#prep air quality data
CO2 <- ADM2_CO2_2015_2020 %>%
  dplyr::select(c(ID_ADM, CO2_mean_2015, CO2_mean_2020))

NO2 <- ADM2_NO2_2020 %>%
  dplyr::select(c(ID_ADM, NO2_mean_2020))
  
PM25 <- ADM2_PM2.5_2000_2019 %>%
  dplyr::select(c(ID_ADM, pm25_mean_2000, pm25_mean_2005, pm25_mean_2010, pm25_mean_2015, pm25_mean_2019))

#prep population density data
population <- ADM2_POP_2000_2020 %>%
  dplyr::select(c(ID_ADM, POP_mean_2000, POP_mean_2005, POP_mean_2010, POP_mean_2015, POP_mean_2020))

# Landcover
#prep forest data
forest <- ADM2_LOSS_2000_2020 

#prep cropland data
cropland <- ADM2_LAND_2001_2020 

#prep lights data
lights <- ADM2_NTL_2015_2020 %>%
  dplyr::select(c(ID_ADM, NTL_mean_2015, NTL_mean_2020)) 

# Urban density
urban <- ADM2_URBAN_2000_2020 

RWI <- ADM2_RWI %>%
  dplyr::select(c(ID_ADM, RWI_mean))

ACLED <- ADM2_ACLED_2015_2020 %>%
  group_by(ID_ADM, EVENT_TYPE) %>%
  summarise(n = sum(N_Conflict)) %>%
  pivot_wider(names_from = EVENT_TYPE, values_from = n) %>%
  replace(is.na(.), 0)
colnames(ACLED)[-1] <- paste0(colnames(ACLED)[-1], '_2015_2020')

# Merge ALL
indices_ALL <- shape %>%
  st_drop_geometry() %>%
  dplyr::select(c(ID_ADM, area_sqkm))

LIST <- list(CO2, NO2, PM25, flood, earthquake, drought, forest, precipitation, temperature, 
             road, friction, 
             cropland, lights, urban, RWI, population, ACLED)

# Make sure that each data frame has the FULL number of rows
for (FILE in LIST) {
  FILE <- FILE %>%
    mutate(ID_ADM = as.numeric(ID_ADM))
  indices_ALL <- left_join(indices_ALL, FILE, by = 'ID_ADM')
  }

#indices_ALL <- full_join(indices_ALL, idp, by = 'NAME_ADM')
indices_ALL <- indices_ALL %>%
  mutate(FLOOD_1995_2000 = replace_na(FLOOD_1995_2000, 0),
         FLOOD_2001_2005 = replace_na(FLOOD_2001_2005, 0),
         FLOOD_2006_2010 = replace_na(FLOOD_2006_2010, 0),
         FLOOD_2011_2015 = replace_na(FLOOD_2011_2015, 0),
         FLOOD_2016_2020 = replace_na(FLOOD_2016_2020, 0),
         QUAKE_1995_2000 = replace_na(QUAKE_1995_2000, 0),
         QUAKE_2001_2005 = replace_na(QUAKE_2001_2005, 0),
         QUAKE_2006_2010 = replace_na(QUAKE_2006_2010, 0),
         QUAKE_2011_2015 = replace_na(QUAKE_2011_2015, 0),
         QUAKE_2016_2020 = replace_na(QUAKE_2016_2020, 0),
         Battles_2015_2020 = replace_na(Battles_2015_2020, 0),
         `Explosions/Remote violence_2015_2020` = replace_na(`Explosions/Remote violence_2015_2020`, 0),
         Protests_2015_2020 = replace_na(Protests_2015_2020, 0),
         Riots_2015_2020 = replace_na(Riots_2015_2020, 0),
         `Strategic developments_2015_2020` = replace_na(`Strategic developments_2015_2020`, 0),
         `Violence against civilians_2015_2020` = replace_na(`Violence against civilians_2015_2020`, 0))
  
#Clean working space
rm(list=setdiff(ls(), c('indices_ALL', 'dir_in', 'dir_out', 'dir_fig', 'dir_shp', 'shape', 'CRS_uni')))

shape_df <- shape %>% st_drop_geometry()

write_csv(x = indices_ALL, file = paste0(dir_out, "Vul_Indicators_ADM2.csv"))

indices_ALL <- read_csv(paste0(dir_out, "Vul_Indicators_ADM2.csv")) %>%
  rowwise() %>%
  mutate(CDI_2001_mean = mean(c_across(c(CDI_mean_200101, CDI_mean_200102, CDI_mean_200103, CDI_mean_200104, CDI_mean_200105, CDI_mean_200106,
                                         CDI_mean_200107, CDI_mean_200108, CDI_mean_200109, CDI_mean_200110, CDI_mean_200111, CDI_mean_200112)), na.rm = TRUE),
         CDI_2005_mean = mean(c_across(c(CDI_mean_200501, CDI_mean_200502, CDI_mean_200503, CDI_mean_200504, CDI_mean_200505, CDI_mean_200506, 
                                         CDI_mean_200507, CDI_mean_200508, CDI_mean_200509, CDI_mean_200510, CDI_mean_200511, CDI_mean_200512)), na.rm = TRUE),
         CDI_2010_mean = mean(c_across(c(CDI_mean_201001, CDI_mean_201002, CDI_mean_201003, CDI_mean_201004, CDI_mean_201005, CDI_mean_201006, 
                                         CDI_mean_201007, CDI_mean_201008, CDI_mean_201009, CDI_mean_201010, CDI_mean_201011, CDI_mean_201012)), na.rm = TRUE),
         CDI_2015_mean = mean(c_across(c(CDI_mean_201501, CDI_mean_201502, CDI_mean_201503, CDI_mean_201504, CDI_mean_201505, CDI_mean_201506, 
                                         CDI_mean_201507, CDI_mean_201508, CDI_mean_201509, CDI_mean_201510, CDI_mean_201511, CDI_mean_201512)), na.rm = TRUE),
         CDI_2020_mean = mean(c_across(c(CDI_mean_202001, CDI_mean_202002, CDI_mean_202003, CDI_mean_202004, CDI_mean_202005, CDI_mean_202006, 
                                         CDI_mean_202007, CDI_mean_202008, CDI_mean_202009, CDI_mean_202010, CDI_mean_202011, CDI_mean_202012)), na.rm = TRUE))
  
indices_ALL <- indices_ALL %>%
  dplyr::select(-starts_with('CDI_mean_')) 
#write_csv(indices_ALL, paste0(dir_out, 'Vul_Indicators_ADM2_original.csv'))
# shape_map <- left_join(shape, indices_ALL, by = c('ID_ADM')) %>%
#   mutate(NO2_mean_2020 = NO2_mean_2020 * 10000,
#          FRICTION_mean_2019 = FRICTION_mean_2019 * 100)
# summary(shape_map$Battles_2015_2020)
# colnames(indices_ALL)
```

# Breaks and mapping functions
```{r map_fun}
breaks_fun <- function(var_in, dig = 2, LOW = NA, HIGH = NA, breaks = 7, style = style){
  
  if (style == 'fixed') {
    brk <- classIntervals(var_in, n = breaks, fixedBreaks = seq(LOW, HIGH, length.out = breaks), style = style)
  } else {
    brk <- classIntervals(var_in, n = breaks, style = style)
  }
  
  brk$brks <- round(brk$brks, digits = dig) 
  var_in <- round(var_in, digits = dig)
  var_out <- cut(var_in, breaks = c(brk$brks), dig.lab = 7, include.lowest = TRUE, include.highest = TRUE)
  return(var_out)
}

map_fun <- function(SHAPE, SHAPE_0 = shape_0, TITLE, SOURCE, NOTE, LEGEND, DIR){
  
  names(COLOR) <- levels(SHAPE$map_var)
  
  map <- ggplot() +
    geom_sf(data = SHAPE, aes(fill = map_var),
            linewidth = 0.05, alpha = 0.8, color = "black") +
    theme_classic() +
    theme(text = element_text(color = "#22211d"),
          axis.line = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5),
          plot.caption = element_text(hjust = 0.5),
          legend.text = element_text(size = 15),
          legend.title = element_text(size = 15),
          legend.position = "right") + 
    labs(x = NULL, 
         y = NULL, 
         title = TITLE, 
         subtitle = SOURCE, 
         caption = NOTE) +
    geom_sf(data = SHAPE_0, fill = NA,
            linewidth = 0.2, alpha = 0.8, color = "blue") +
    scale_fill_manual(name=LEGEND, drop = F,
                      values=COLOR, na.value = 'black',
                      guide = guide_legend(
                        keyheight = unit(10, units = "mm"),
                        keywidth = unit(15, units = "mm"),
                        title.position = 'top',
                        reverse= F,
                        title.hjust = 0.5,
                        label.hjust = 0.5))
  
  map 
  ggsave(paste0(DIR, paste0(TITLE, ".png")), height= 12, width = 16, units = c("in"))
}
```

## Maps
## Exposure
### Exposure to natural hazards
```{r exposure_natural, eval = F}
COUNTRY_LIST <- unique(shape_map$WB_ADM0_NA)
VAR_LIST <- colnames(indices_ALL)[-c(1, 2)]
VAR_LIST
COLOR_LIST <- c(rep('Greens', 92), rep('Blues', 2), rep('Purples', 18), rep('YlGnBu', 23))
TITLE_LIST <- c(paste0('CO2 ', seq.int(2015, 2020, 5)), 'NO2 2020 (*1000)', paste0('PM2.5 ', seq.int(2000, 2015, 5)), 'PM2.5 2019',
                'Flood 2001 - 2005', 'Flood 2016 - 2020', 'Flood 1995 - 2000', 'Flood 2006 - 2010', 'Flood 2011 - 2015', 
                'Earthquake 2001 - 2005', 'Earthquake 2006 - 2010', 'Earthquake 1995 - 2000', 'Earthquake 2011 - 2015', 'Earthquake 2016 - 2020', 
                paste0('CDI ', format(seq(ymd('2001-01-01'),ymd('2001-12-31'), by = '1 month'), '%Y %b')),
                paste0('CDI ', format(seq(ymd('2005-01-01'),ymd('2005-12-31'), by = '1 month'), '%Y %b')),
                paste0('CDI ', format(seq(ymd('2010-01-01'),ymd('2010-12-31'), by = '1 month'), '%Y %b')),
                paste0('CDI ', format(seq(ymd('2015-01-01'),ymd('2015-12-31'), by = '1 month'), '%Y %b')),
                paste0('CDI ', format(seq(ymd('2020-01-01'),ymd('2020-12-31'), by = '1 month'), '%Y %b')),
                'Forest Cover (sqkm) 2000', 'No Forest Loss (sqkm) 2001 - 2020', 
                'Forest Loss 2001 - 2005', 'Flood 2006 - 2010', 'Flood 2011 - 2015', 'Flood 2016 - 2020', 
                'Precipitation Variation 2001 - 2005', 'Precipitation Variation 2006 - 2010', 'Precipitation Variation 2011 - 2015', 'Precipitation Variation 2016 - 2020',
                'Temperature Variation 2000 - 2005', 'Temperature Variation 2006 - 2010', 'Temperature Variation 2011 - 2015', 'Temperature Variation 2016 - 2020',
                'Road Density', 'Surface Friction 2019 (*100)', 'Total Number of Land Pixels', 
                'MODIS Forest Cover 2001', 'MODIS Cropland Cover 2001', 'MODIS Barren Cover 2001',
                'MODIS Forest Cover 2005', 'MODIS Cropland Cover 2005', 'MODIS Barren Cover 2005',
                'MODIS Forest Cover 2010', 'MODIS Cropland Cover 2010', 'MODIS Barren Cover 2010',
                'MODIS Forest Cover 2015', 'MODIS Cropland Cover 2015', 'MODIS Barren Cover 2015',
                'MODIS Forest Cover 2020', 'MODIS Cropland Cover 2020', 'MODIS Barren Cover 2020',
                'NTL 2015', 'NTL 2020',
                'Urban Cover 2000', 'Urban Density 2000', 'Urban Cover 2005', 'Urban Density 2005', 'Urban Cover 2010', 'Urban Density 2010',
                'Urban Cover 2015', 'Urban Density 2015', 'Urban Cover 2020', 'Urban Density 2020', 'Urban Total Pixels 2000',
                'RWI', paste0('Population ', seq.int(2000, 2020, 5)),
                paste0(c('Battles', 'Explosions or Remote Violence', 'Protests', 'Riots', 'Strategic Developments', 'Violence Against Civilians'), ' 2015 - 2020'))
LEGEND_LIST

for (i in 1:21) {
  
  shape_map_sub <- shape_map %>%
    filter(WB_ADM0_NA == COUNTRY_LIST[i])
  
  for (j in 1:135) {
    tryCatch({
      shape_map_sub <- shape_map_sub %>%
        mutate(map_var = breaks_fun(get(VAR_LIST[j])))
    
      COLOR <- brewer.pal(5, COLOR_LIST[j])
    
      map_fun(shape_map_sub, 
              TITLE = paste0(COUNTRY_LIST[i], ' ', TITLE_LIST[j]), 
              SOURCE = '', 
              NOTE = '', 
              LEGEND = '',
              DIR = paste0(dir_fig, COUNTRY_LIST[i], '/'))
    }, error=function(e){})
      print(paste0('DONE: ', COUNTRY_LIST[i], ' ', TITLE_LIST[j]))
  }
}

for (j in 1:135) {
    tryCatch({
      shape_map <- shape_map %>%
        mutate(map_var = breaks_fun(get(VAR_LIST[j])))
    
      COLOR <- brewer.pal(5, COLOR_LIST[j])
    
      map_fun(shape_map, 
              TITLE = paste0('Full ', TITLE_LIST[j]), 
              SOURCE = '', 
              NOTE = '', 
              LEGEND = '',
              DIR = paste0(dir_fig, 'MENA/'))
    }, error=function(e){})
      print(paste0('DONE: ', TITLE_LIST[j]))
}
```

# Main mapping
```{r mapping, eval = F}
shape_map <- left_join(shape, indices_ALL, by = c('ID_ADM')) %>%
  mutate(NO2_mean_2020 = NO2_mean_2020 * 10000,
         FRICTION_mean_2019 = FRICTION_mean_2019 * 100) %>%
  filter(WB_ADM0_NA != 'Israel')

options(scipen = 99999)
VAR_LIST <- c('CO2_mean_2015', 'CO2_mean_2020', 'NO2_mean_2020', 'pm25_mean_2000', 'pm25_mean_2005', 'pm25_mean_2010', 'pm25_mean_2015', 'pm25_mean_2019',
              'FLOOD_1995_2000', 'FLOOD_2001_2005', 'FLOOD_2006_2010', 'FLOOD_2011_2015', 'FLOOD_2016_2020', 
              'QUAKE_1995_2000', 'QUAKE_2001_2005', 'QUAKE_2006_2010', 'QUAKE_2011_2015', 'QUAKE_2016_2020', 
              'Forest_sqkm_2000', 'Loss_sqkm_2001_2005', 'Loss_sqkm_2006_2010', 'Loss_sqkm_2011_2015', 'Loss_sqkm_2016_2020', 
              'PRECIP_DIFF_2001_2005', 'PRECIP_DIFF_2006_2010', 'PRECIP_DIFF_2011_2015', 'PRECIP_DIFF_2016_2020', 
              'TEMP_DIFF_2000_2005', 'TEMP_DIFF_2006_2010', 'TEMP_DIFF_2011_2015', 'TEMP_DIFF_2016_2020', 
              'road_raw', 'FRICTION_mean_2019', 
              'Forest_2001', 'Cropland_2001', 'Barren_2001', 'Forest_2005', 'Cropland_2005', 'Barren_2005',  
              'Forest_2010', 'Cropland_2010', 'Barren_2010', 'Forest_2015', 'Cropland_2015', 'Barren_2015',  
              'Forest_2020',  'Cropland_2020', 'Barren_2020', 
              'NTL_mean_2015', 'NTL_mean_2020', 
              'URBAN_2000', 'URBAN_DEN_2000', 'URBAN_2005', 'URBAN_DEN_2005', 'URBAN_2010', 'URBAN_DEN_2010',
              'URBAN_2015', 'URBAN_DEN_2015', 'URBAN_2020', 'URBAN_DEN_2020',
              'RWI_mean', 'POP_mean_2000', 'POP_mean_2005', 'POP_mean_2010', 'POP_mean_2015', 'POP_mean_2020', 
              'Battles_2015_2020', 'Explosions/Remote violence_2015_2020',
              'Protests_2015_2020', 'Riots_2015_2020', 'Strategic developments_2015_2020', 'Violence against civilians_2015_2020', 
              'CDI_2001_mean', 'CDI_2005_mean', 'CDI_2010_mean', 'CDI_2015_mean', 'CDI_2020_mean')
shape_map <- shape_map %>%
  dplyr::select(all_of(VAR_LIST))

COUNTRY_LIST <- unique(shape_map$WB_ADM0_NA)

COLOR_LIST <- c(rep('Greens', 31), rep('Blues', 2), rep('Purples', 17), rep('YlGnBu', 22), rep('Greens', 5))
TITLE_LIST <- c(paste0('CO2 ', seq.int(2015, 2020, 5)), 'NO2 2020 (*1000)', paste0('PM2.5 ', seq.int(2000, 2015, 5)), 'PM2.5 2019',
                'Flood 1995 - 2000', 'Flood 2001 - 2005', 'Flood 2006 - 2010', 'Flood 2011 - 2015', 'Flood 2016 - 2020', 
                'Earthquake 1995 - 2000', 'Earthquake 2001 - 2005', 'Earthquake 2006 - 2010', 'Earthquake 2011 - 2015', 'Earthquake 2016 - 2020', 
                'Forest Cover (sqkm) 2000', 
                'Forest Loss 2001 - 2005', 'Forest Loss 2006 - 2010', 'Forest Loss 2011 - 2015', 'Forest Loss 2016 - 2020', 
                'Precipitation Variation 2001 - 2005', 'Precipitation Variation 2006 - 2010', 'Precipitation Variation 2011 - 2015', 'Precipitation Variation 2016 - 2020',
                'Temperature Variation 2000 - 2005', 'Temperature Variation 2006 - 2010', 'Temperature Variation 2011 - 2015', 'Temperature Variation 2016 - 2020',
                'Road Density', 'Surface Friction 2019 (*100)', 
                'MODIS Forest Cover 2001', 'MODIS Cropland Cover 2001', 'MODIS Barren Cover 2001',
                'MODIS Forest Cover 2005', 'MODIS Cropland Cover 2005', 'MODIS Barren Cover 2005',
                'MODIS Forest Cover 2010', 'MODIS Cropland Cover 2010', 'MODIS Barren Cover 2010',
                'MODIS Forest Cover 2015', 'MODIS Cropland Cover 2015', 'MODIS Barren Cover 2015',
                'MODIS Forest Cover 2020', 'MODIS Cropland Cover 2020', 'MODIS Barren Cover 2020',
                'NTL 2015', 'NTL 2020',
                'Urban Cover 2000', 'Urban Density 2000', 'Urban Cover 2005', 'Urban Density 2005', 'Urban Cover 2010', 'Urban Density 2010',
                'Urban Cover 2015', 'Urban Density 2015', 'Urban Cover 2020', 'Urban Density 2020', 
                'Relative Wealth Index', paste0('Population ', seq.int(2000, 2020, 5)),
                paste0(c('Battles', 'Explosions or Remote Violence', 'Protests', 'Riots', 'Strategic Developments', 'Violence Against Civilians'), ' 2015 - 2020'),
                'CDI 2001', 'CDI 2005', 'CDI 2010', 'CDI 2015', 'CDI 2020')

SOURCE_LIST <- c(rep('NASA OCO-2', 2), 'Sentinel-5P NRTI NO2', rep('NASA SEDAC', 5), rep('Dartmouth Global Flood Observatory', 5), rep('USGS Earthquake Catalog', 5),
               rep('Hansen Global Forest Change', 5), rep('NASA GPM', 4), rep('NASA GLDAS', 4),
               'OSM', 'Oxford MAP (*100)', rep('MODIS', 15),
               rep('NOAA VIIRS Nighttime Lights Annual Composite', 2), rep('ECMRWF', 10), 
               'Facebook', rep('WorldPop', 5), rep('ACLED', 6), rep('ICBA', 5))
LEGEND_LIST <- c(rep('CO2 Concentration', 2), 'NO2 Density (*1000)', rep('PM2.5 Concentration', 5), rep('#Floods', 5), rep('#Earthquakes', 5),
               'Forest Cover (sqkm)', rep('Forest Loss (sqkm)', 4), rep('Precipitation Variation', 4), rep('Temperature Variation', 4),
               'Road Density', 'Surface Friction', rep(c('Forest Cover (#pixels)', 'Cropland Cover (#pixels)', 'Barren Cover (#pixels)'), 5),
               rep('NTL Intensity', 2), rep(c('Urban Cover (#pixels)', 'Urban Density (%)'), 5), 
               'RWI', rep('Population', 5), rep('#Conflicts', 6), rep('CDI', 5))
NOTE_LIST <- c(rep('Level of CO2 concentration. A higher value represents greater exposure to CO2.', 2), 
               'Concentrations of collective nitrogen oxides. A higher value represents greater exposure to NO2.', 
               rep('Level of fine particulate matter (PM2.5) concentration. A higher value represents greater exposure to air pollution.', 5), 
               rep('Total number of floods.', 5), rep('Total number of earthquakes with a magnitude of 4.5 or higher.', 5),
               rep('Total forest land (sqkm) lost.', 5), 
               rep('Average variation in precipitation (mm3) per month.', 4), 
               rep('Average variation in soil temperature (0 - 10cm) per month.', 4),
               'Density of roads (length of roads/area)', 'Nominal overall speed of travel based on land-based motorized transport.', 
               rep(c('Total number of pixels identified as forest. Each pixel is roughly of 500m by 500m in size.', 
                     'Total number of pixels identified as partial or full cropland. Each pixel is roughly of 500m by 500m in size.',
                     'Total number of pixels identified as barren. Each pixel is roughly of 500m by 500m in size.'), 5), 
               rep('Nighttime radiance value weighted by area. A higher value represents a higher radiance.', 2), 
               rep(c('Total number of pixels classified as built area. Each pixel is roughly of 300m by 300m in size.', 
                     'Percentage of urban pixels out of all land area (pixels).'), 5),  
               'Relative Wealth Index. A higher value represents higher living standards.', rep('Total number of inhabitants.', 5), 
               rep('Number of conflicts.', 6), rep('Average annual Composite Drought Index (CDI). A higher value represents a higher exposure to drought.', 5))
DIG_LIST <- c(rep(2, 3), rep(0, 5), rep(1, 10), 0, rep(0, 4), rep(2, 8), 0, 2, rep(0, 15), rep(0, 2), rep(0, 10),
              2, rep(0, 5), rep(0, 6), rep(2, 5))
BREAK_LIST <- c(rep(7, 19), rep(5, 5), rep(7, 53))
STYLE_LIST <- c(rep('fixed', 2), 'fisher', rep('fixed', 15), 'fisher', rep('fixed', 12), rep('fisher', 2), 
                rep('fixed', 27), 'fisher', rep('fixed', 5), rep('fisher', 6), rep('fixed', 5))
BREAK_MIN_LIST <- c(rep(395.70, 2), NA, rep(8, 5), rep(0, 5), rep(0, 5), NA, rep(0, 4), rep(0.13, 4), rep(0, 4), NA, NA, 
                    rep(c(0, 0, 0), 5), rep(0, 2), rep(c(0, 0), 5), NA, rep(0, 5), NA, NA, NA, NA, NA, NA, rep(0, 5))
BREAK_MAX_LIST <- c(rep(416.10, 2), NA, rep(72, 5), rep(4, 5), rep(31, 5), NA, rep(382, 4), rep(275.17, 4), rep(5.50, 4), NA, NA, 
                    rep(c(4048, 30202, 2064344), 5), rep(215, 2), rep(c(19393, 100), 5), NA, rep(34618, 5), NA, NA, NA, NA, NA, NA, rep(1, 5))
LISTS <- data.frame('VAR' = VAR_LIST, 
                    'TITLE' = TITLE_LIST,
                    'SOURCE' = SOURCE_LIST,
                    'NOTE' = NOTE_LIST,
                    'LEGEND' = LEGEND_LIST,
                    'COLOR' = COLOR_LIST,
                    'DIGIT' = DIG_LIST,
                    'BREAK' = BREAK_LIST,
                    'STYLE' = STYLE_LIST,
                    'BREAK_MIN' = BREAK_MIN_LIST,
                    'BREAK_MAX' = BREAK_MAX_LIST)

# test <- c(indices_ALL$CDI_2001_mean, indices_ALL$CDI_2005_mean, indices_ALL$CDI_2010_mean, indices_ALL$CDI_2015_mean, indices_ALL$CDI_2020_mean)
# min(test, na.rm = T)
# max(test, na.rm = T)
i=1
for (i in 1:nrow(LISTS)) {
    #tryCatch({

  shape_map <- shape_map %>%
    mutate(map_var = breaks_fun(get(LISTS$VAR[i]), LOW = LISTS$BREAK_MIN[i], HIGH = LISTS$BREAK_MAX[i], 
                                breaks = LISTS$BREAK[i], dig = LISTS$DIGIT[i], style = LISTS$STYLE[i]))
  
  COLOR <- brewer.pal(LISTS$BREAK[i], LISTS$COLOR[i])
  
  map_fun(shape_map, 
          TITLE = paste0('MENA ', LISTS$TITLE[i]), 
          SOURCE = LISTS$SOURCE[i],
          NOTE = LISTS$NOTE[i], 
          LEGEND = LISTS$LEGEND[i],
          DIR = paste0(dir_fig, 'MENA/'))
  #}, error=function(e){})
  print(paste0('DONE: ', LISTS$TITLE[i]))
}

```

# Raster mapping
```{r rast}
shape_border <- read_sf(paste0(dir_shp, 'MENA_ADM0.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()

# Load raster data (vectorized): nightlight 2015
raster_temp <- read_sf(paste0(dir_ras, 'Light_2015.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()

# Nightlight
ggplot() + geom_sf(data = raster_temp, aes(fill = log(DN+1)), color = NA, alpha = 0.8) +
  scale_fill_viridis_c(limits = c(0, 12), direction = 1, name = 'Nightlight\nIntensity (log)') +
  geom_sf(data = shape_border, fill = NA,
          size = 1, color = 'blue4') +
  theme_void() 
  
ggsave(paste0(dir_fig, paste0('/MENA/Raster/Nightlight_2015.png')), height= 12, width = 16, units = c("in"))

# Load raster data (vectorized): nightlight 2020
raster_temp <- read_sf(paste0(dir_ras, 'Light_2020.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()

# Nightlight
ggplot() + geom_sf(data = raster_temp, aes(fill = log(DN+1)), color = NA, alpha = 0.8) +
  scale_fill_viridis_c(limits = c(0, 12), direction = 1, name = 'Nightlight\nIntensity (log)') +
  geom_sf(data = shape_border, fill = NA,
          size = 1, color = 'blue4') +
  theme_void() 

ggsave(paste0(dir_fig, paste0('/MENA/Raster/Nightlight_2020.png')), height= 12, width = 16, units = c("in"))

# 2020 max: 138314
# 2015 max: 93422
# 2010 max: 79284
# 2005 max: 70444
# 2000 max: 72312
options(scipen = 999)
# Load raster data (vectorized): Population 2000
raster_temp <- read_sf(paste0(dir_ras, 'Pop_2000.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()

# Population
ggplot() + geom_sf(data = shape_border, fill = 'white',
                   size = 1, color = 'blue4') +
  geom_sf(data = raster_temp, aes(fill = log(DN)), color = NA) +
  scale_fill_gradient2(limits = c(0, 12), 
                         name = 'Population\nCount (log)',
                         high = 'blue', low = 'white') +
  theme_void() 
  
ggsave(paste0(dir_fig, paste0('/MENA/Raster/Population_2000.png')), height= 12, width = 16, units = c("in"))

# Load raster data (vectorized): Population 2005
raster_temp <- read_sf(paste0(dir_ras, 'Pop_2005.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()
# Population
ggplot() + geom_sf(data = shape_border, fill = 'white',
                   size = 1, color = 'blue4') +
  geom_sf(data = raster_temp, aes(fill = log(DN)), color = NA) +
  scale_fill_gradient2(limits = c(0, 12), 
                         name = 'Population\nCount (log)',
                         high = 'blue', low = 'white') +
  theme_void() 
ggsave(paste0(dir_fig, paste0('/MENA/Raster/Population_2005.png')), height= 12, width = 16, units = c("in"))

# Load raster data (vectorized): Population 2010
raster_temp <- read_sf(paste0(dir_ras, 'Pop_2010.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()
# Population
ggplot() + geom_sf(data = shape_border, fill = 'white',
                   size = 1, color = 'blue4') +
  geom_sf(data = raster_temp, aes(fill = log(DN)), color = NA) +
  scale_fill_gradient2(limits = c(0, 12), 
                         name = 'Population\nCount (log)',
                         high = 'blue', low = 'white') +
  theme_void() 
ggsave(paste0(dir_fig, paste0('/MENA/Raster/Population_2010.png')), height= 12, width = 16, units = c("in"))

# Load raster data (vectorized): Population 2015
raster_temp <- read_sf(paste0(dir_ras, 'Pop_2015.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()
# Population
ggplot() + geom_sf(data = shape_border, fill = 'white',
                   size = 1, color = 'blue4') +
  geom_sf(data = raster_temp, aes(fill = log(DN)), color = NA) +
  scale_fill_gradient2(limits = c(0, 12), 
                         name = 'Population\nCount (log)',
                         high = 'blue', low = 'white') +
  theme_void() 
ggsave(paste0(dir_fig, paste0('/MENA/Raster/Population_2015.png')), height= 12, width = 16, units = c("in"))

# Load raster data (vectorized): Population 2020
raster_temp <- read_sf(paste0(dir_ras, 'Pop_2020.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()
# Population
ggplot() + geom_sf(data = shape_border, fill = 'white',
                   size = 1, color = 'blue4') +
  geom_sf(data = raster_temp, aes(fill = log(DN)), color = NA) +
  scale_fill_gradient2(limits = c(0, 12), 
                         name = 'Population\nCount (log)',
                         high = 'blue', low = 'white') +
  theme_void() 
ggsave(paste0(dir_fig, paste0('/MENA/Raster/Population_2020.png')), height= 12, width = 16, units = c("in"))
```

# Road density lines
```{r road_lines, eval = F}
shape_border <- read_sf(paste0(dir_shp, 'MENA_ADM0.shp')) %>%
  st_transform(CRS_uni) %>% 
  st_make_valid()

road_lines <- read_sf('/Users/ashitakarl/Desktop/Project/WB/MENA/OSM/full_roads.shp') %>%
  st_transform(CRS_uni) 

ggplot() +
  geom_sf(data = shape_border, fill = 'gray95',
          linewidth = 0.2, color = "grey80") +
  geom_sf(data = shape_0, fill = NA,
          linewidth = 0.2, alpha = 0.8, color = "black") +
  geom_sf(data = road_lines, color = '#1F78B4',
          linewidth = 0.1) +
  theme_void() + 
  labs(x = NULL, 
       y = NULL, 
       title = '', 
       subtitle = '', 
       caption = '')

ggsave(paste0(dir_fig, '/MENA/Raster/Roads.png'), height= 12, width = 16, units = c("in"))
```

```{r agg_index_norm, eval = F}
# indices_ALL <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_original.csv'))
# indices_ALL <- left_join(shape, indices_ALL, by = c('ID_ADM')) %>%
#   filter(WB_ADM0_NA != 'Israel') %>%
#   mutate(NO2_mean_2020 = NO2_mean_2020 * 10000,
#          FRICTION_mean_2019 = FRICTION_mean_2019 * 100,
#          pm25_2000 = normalize(pm25_mean_2000, method = 'range', range = c(0,1)),
#          pm25_2005 = normalize(pm25_mean_2005, method = 'range', range = c(0,1)),
#          pm25_2010 = normalize(pm25_mean_2010, method = 'range', range = c(0,1)),
#          pm25_2015 = normalize(pm25_mean_2015, method = 'range', range = c(0,1)),
#          pm25_2019 = normalize(pm25_mean_2019, method = 'range', range = c(0,1)),
#          flood_2005 = normalize(FLOOD_2001_2005, method = 'range', range = c(0,1)),
#          flood_2010 = normalize(FLOOD_2006_2010, method = 'range', range = c(0,1)),
#          flood_2015 = normalize(FLOOD_2011_2015, method = 'range', range = c(0,1)),
#          flood_2020 = normalize(FLOOD_2016_2020, method = 'range', range = c(0,1)),
#          quake_2005 = normalize(QUAKE_2001_2005, method = 'range', range = c(0,1)),
#          quake_2010 = normalize(QUAKE_2006_2010, method = 'range', range = c(0,1)),
#          quake_2015 = normalize(QUAKE_2011_2015, method = 'range', range = c(0,1)),
#          quake_2020 = normalize(QUAKE_2016_2020, method = 'range', range = c(0,1)),
#          loss_2005 = normalize(Loss_sqkm_2001_2005, method = 'range', range = c(0,1)),
#          loss_2010 = normalize(Loss_sqkm_2006_2010, method = 'range', range = c(0,1)),
#          loss_2015 = normalize(Loss_sqkm_2011_2015, method = 'range', range = c(0,1)),
#          loss_2020 = normalize(Loss_sqkm_2016_2020, method = 'range', range = c(0,1)),
#          precip_2005 = normalize(PRECIP_DIFF_2001_2005, method = 'range', range = c(0,1)),
#          precip_2010 = normalize(PRECIP_DIFF_2006_2010, method = 'range', range = c(0,1)),
#          precip_2015 = normalize(PRECIP_DIFF_2011_2015, method = 'range', range = c(0,1)),
#          precip_2020 = normalize(PRECIP_DIFF_2016_2020, method = 'range', range = c(0,1)),
#          temp_2005 = normalize(TEMP_DIFF_2000_2005, method = 'range', range = c(0,1)),
#          temp_2010 = normalize(TEMP_DIFF_2006_2010, method = 'range', range = c(0,1)),
#          temp_2015 = normalize(TEMP_DIFF_2011_2015, method = 'range', range = c(0,1)),
#          temp_2020 = normalize(TEMP_DIFF_2016_2020, method = 'range', range = c(0,1)),
#          drought_2001 = normalize(CDI_2001_mean, method = 'range', range = c(0,1)),
#          drought_2005 = normalize(CDI_2005_mean, method = 'range', range = c(0,1)),
#          drought_2010 = normalize(CDI_2010_mean, method = 'range', range = c(0,1)),
#          drought_2015 = normalize(CDI_2015_mean, method = 'range', range = c(0,1)),
#          drought_2020 = normalize(CDI_2020_mean, method = 'range', range = c(0,1)),
#          Exposure_2000_2005 = pm25_2005 + flood_2005 + quake_2005 + loss_2005 + precip_2005 + temp_2005 + drought_2005,
#          Exposure_2000_2005 = normalize(Exposure_2000_2005, method = 'range', range = c(0,1)),
#          Exposure_2006_2010 = pm25_2010 + flood_2010 + quake_2010 + loss_2010 + precip_2010 + temp_2010 + drought_2010,
#          Exposure_2006_2010 = normalize(Exposure_2006_2010, method = 'range', range = c(0,1)),
#          Exposure_2011_2015 = pm25_2015 + flood_2015 + quake_2015 + loss_2015 + precip_2015 + temp_2015 + drought_2015,
#          Exposure_2011_2015 = normalize(Exposure_2011_2015, method = 'range', range = c(0,1)),
#          Exposure_2016_2020 = pm25_2019 + flood_2020 + quake_2020 + loss_2020 + precip_2020 + temp_2020 + drought_2020,
#          Exposure_2016_2020 = normalize(Exposure_2016_2020, method = 'range', range = c(0,1)),
#          crop_2001 = normalize(Cropland_2001, method = 'range', range = c(0,1)),
#          crop_2005 = normalize(Cropland_2005, method = 'range', range = c(0,1)),
#          crop_2010 = normalize(Cropland_2010, method = 'range', range = c(0,1)),
#          crop_2015 = normalize(Cropland_2015, method = 'range', range = c(0,1)),
#          crop_2020 = normalize(Cropland_2020, method = 'range', range = c(0,1)),
#          ntl_2015 = normalize(NTL_mean_2015, method = 'range', range = c(0,1)),
#          ntl_2020 = normalize(NTL_mean_2020, method = 'range', range = c(0,1)),
#          Population_2015_log = log(POP_mean_2015),
#          Population_2015_log_norm = normalize(Population_2015_log, method = 'range', range = c(0,1)),
#          Population_2020_log = log(POP_mean_2020),
#          Population_2020_log_norm = normalize(Population_2020_log, method = 'range', range = c(0,1)),
#          Econ_2011_2015 = crop_2015 + ntl_2015,
#          Econ_2011_2015 = normalize(Econ_2011_2015, method = 'range', range = c(0,1)),
#          Econ_2016_2020 = crop_2020 + ntl_2020,
#          Econ_2016_2020 = normalize(Econ_2016_2020, method = 'range', range = c(0,1)),
#          Vul_2011_2015 = Exposure_2011_2015 - Econ_2011_2015,
#          Vul_2011_2015 = normalize(Vul_2011_2015, method = 'range', range = c(0,1)),
#          Vul_2016_2020 = Exposure_2016_2020 - Econ_2016_2020,
#          Vul_2016_2020 = normalize(Vul_2016_2020, method = 'range', range = c(0,1)),
#          VulPop_2011_2015 = Exposure_2011_2015 - Econ_2011_2015 + Population_2015_log_norm,
#          VulPop_2011_2015 = normalize(VulPop_2011_2015, method = 'range', range = c(0, 1)),
#          VulPop_2016_2020 = Exposure_2016_2020 - Econ_2016_2020 + Population_2020_log_norm,
#          VulPop_2016_2020 = normalize(VulPop_2016_2020, method = 'range', range = c(0, 1)),
#          VulPopSh_2011_2015 = Vul_2011_2015 * Population_2015_log,
#          VulPopSh_2011_2015 = normalize(VulPopSh_2011_2015, method = 'range', range = c(0, 1)),
#          VulPopSh_2016_2020 = Vul_2016_2020 * Population_2020_log,
#          VulPopSh_2016_2020 = normalize(VulPopSh_2016_2020, method = 'range', range = c(0, 1))) %>%
#   dplyr::select(c(ID_ADM, WB_ADM0_NA,
#                   pm25_2000, pm25_2005, pm25_2010, pm25_2015, pm25_2019,
#                   flood_2005, flood_2010, flood_2015, flood_2020,
#                   quake_2005, quake_2010, quake_2015, quake_2020,
#                   loss_2005, loss_2010, loss_2015, loss_2020,
#                   precip_2005, precip_2010, precip_2015, precip_2020,
#                   temp_2005, temp_2010, temp_2015, temp_2020,
#                   drought_2001, drought_2005, drought_2010, drought_2015, drought_2020,
#                   crop_2001, crop_2005, crop_2010, crop_2015, crop_2020,
#                   ntl_2015, ntl_2020,
#                   Population_2015_log, Population_2015_log_norm, Population_2020_log, Population_2020_log_norm,
#                   Exposure_2000_2005, Exposure_2006_2010, Exposure_2011_2015, Exposure_2016_2020,
#                   Econ_2011_2015, Econ_2016_2020, Vul_2011_2015, Vul_2016_2020,
#                   VulPop_2011_2015, VulPop_2016_2020, VulPopSh_2011_2015, VulPopSh_2016_2020)) %>%
#   st_drop_geometry()
# write_csv(indices_ALL, paste0(dir_out, '/Index/Vul_Indicators_ADM2_norm.csv'))

indices_ALL <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_norm.csv'))
shape_map <- shape %>%
  filter(WB_ADM0_NA != 'Israel') %>%
  left_join(indices_ALL, by = 'ID_ADM')

# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2000_2005, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2000 - 2005)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2006_2010, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2006 - 2010)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))

# Economic Activity
shape_map$map_var <- breaks_fun(shape_map$Econ_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Purples')
map_fun(shape_map, 
        TITLE = 'Economic Activity Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of cropland coverage and nightlight intensity.', 
        LEGEND = 'Relative Economic Activity Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
# Economic Activity
shape_map$map_var <- breaks_fun(shape_map$Econ_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Purples')
map_fun(shape_map, 
        TITLE = 'Economic Activity Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of cropland coverage and nightlight intensity.', 
        LEGEND = 'Relative Economic Activity Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))

# Vulnerability Index
shape_map$map_var <- breaks_fun(shape_map$Vul_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
# Vulnerability Index
shape_map$map_var <- breaks_fun(shape_map$Vul_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))

# Vulnerability Index with population 2015
shape_map$map_var <- breaks_fun(shape_map$VulPop_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability with Total Population (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity + Population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
# Vulnerability Index with population 2020
shape_map$map_var <- breaks_fun(shape_map$VulPop_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability with Total Population (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity + Population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))

# Vulnerability Index weighted by population 2015 log
shape_map$map_var <- breaks_fun(shape_map$VulPopSh_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability weighted by Population (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value of Vulnerability Index weighted by population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
# Vulnerability Index weighted by population 2020 log
shape_map$map_var <- breaks_fun(shape_map$VulPopSh_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability weighted by Population (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value of Vulnerability Index weighted by population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Normalized/'))
```

```{r agg_index_std, eval = F}
# indices_ALL <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_original.csv'))
# indices_ALL <- left_join(shape, indices_ALL, by = c('ID_ADM')) %>%
#   filter(WB_ADM0_NA != 'Israel') %>%
#   mutate(NO2_mean_2020 = NO2_mean_2020 * 10000,
#          FRICTION_mean_2019 = FRICTION_mean_2019 * 100,
#          pm25_2000 = normalize(pm25_mean_2000, method = 'standardize'),
#          pm25_2005 = normalize(pm25_mean_2005, method = 'standardize'),
#          pm25_2010 = normalize(pm25_mean_2010, method = 'standardize'),
#          pm25_2015 = normalize(pm25_mean_2015, method = 'standardize'),
#          pm25_2019 = normalize(pm25_mean_2019, method = 'standardize'),
#          flood_2005 = normalize(FLOOD_2001_2005, method = 'standardize'),
#          flood_2010 = normalize(FLOOD_2006_2010, method = 'standardize'),
#          flood_2015 = normalize(FLOOD_2011_2015, method = 'standardize'),
#          flood_2020 = normalize(FLOOD_2016_2020, method = 'standardize'),
#          quake_2005 = normalize(QUAKE_2001_2005, method = 'standardize'),
#          quake_2010 = normalize(QUAKE_2006_2010, method = 'standardize'),
#          quake_2015 = normalize(QUAKE_2011_2015, method = 'standardize'),
#          quake_2020 = normalize(QUAKE_2016_2020, method = 'standardize'),
#          loss_2005 = normalize(Loss_sqkm_2001_2005, method = 'standardize'),
#          loss_2010 = normalize(Loss_sqkm_2006_2010, method = 'standardize'),
#          loss_2015 = normalize(Loss_sqkm_2011_2015, method = 'standardize'),
#          loss_2020 = normalize(Loss_sqkm_2016_2020, method = 'standardize'),
#          precip_2005 = normalize(PRECIP_DIFF_2001_2005, method = 'standardize'),
#          precip_2010 = normalize(PRECIP_DIFF_2006_2010, method = 'standardize'),
#          precip_2015 = normalize(PRECIP_DIFF_2011_2015, method = 'standardize'),
#          precip_2020 = normalize(PRECIP_DIFF_2016_2020, method = 'standardize'),
#          temp_2005 = normalize(TEMP_DIFF_2000_2005, method = 'standardize'),
#          temp_2010 = normalize(TEMP_DIFF_2006_2010, method = 'standardize'),
#          temp_2015 = normalize(TEMP_DIFF_2011_2015, method = 'standardize'),
#          temp_2020 = normalize(TEMP_DIFF_2016_2020, method = 'standardize'),
#          drought_2001 = normalize(CDI_2001_mean, method = 'standardize'),
#          drought_2005 = normalize(CDI_2005_mean, method = 'standardize'),
#          drought_2010 = normalize(CDI_2010_mean, method = 'standardize'),
#          drought_2015 = normalize(CDI_2015_mean, method = 'standardize'),
#          drought_2020 = normalize(CDI_2020_mean, method = 'standardize'),
#          Exposure_2000_2005 = pm25_2005 + flood_2005 + quake_2005 + loss_2005 + precip_2005 + temp_2005 + drought_2005,
#          Exposure_2000_2005 = normalize(Exposure_2000_2005, method = 'range', range = c(0,1)),
#          Exposure_2006_2010 = pm25_2010 + flood_2010 + quake_2010 + loss_2010 + precip_2010 + temp_2010 + drought_2010,
#          Exposure_2006_2010 = normalize(Exposure_2006_2010, method = 'range', range = c(0,1)),
#          Exposure_2011_2015 = pm25_2015 + flood_2015 + quake_2015 + loss_2015 + precip_2015 + temp_2015 + drought_2015,
#          Exposure_2011_2015 = normalize(Exposure_2011_2015, method = 'range', range = c(0,1)),
#          Exposure_2016_2020 = pm25_2019 + flood_2020 + quake_2020 + loss_2020 + precip_2020 + temp_2020 + drought_2020,
#          Exposure_2016_2020 = normalize(Exposure_2016_2020, method = 'range', range = c(0,1)),
#          crop_2001 = normalize(Cropland_2001, method = 'standardize'),
#          crop_2005 = normalize(Cropland_2005, method = 'standardize'),
#          crop_2010 = normalize(Cropland_2010, method = 'standardize'),
#          crop_2015 = normalize(Cropland_2015, method = 'standardize'),
#          crop_2020 = normalize(Cropland_2020, method = 'standardize'),
#          ntl_2015 = normalize(NTL_mean_2015, method = 'standardize'),
#          ntl_2020 = normalize(NTL_mean_2020, method = 'standardize'),
#          Population_2015_log = log(POP_mean_2015),
#          Population_2015_log_norm = normalize(Population_2015_log, method = 'range', range = c(0,1)),
#          Population_2020_log = log(POP_mean_2020),
#          Population_2020_log_norm = normalize(Population_2020_log, method = 'range', range = c(0,1)),
#          Econ_2011_2015 = crop_2015 + ntl_2015,
#          Econ_2011_2015 = normalize(Econ_2011_2015, method = 'range', range = c(0,1)),
#          Econ_2016_2020 = crop_2020 + ntl_2020,
#          Econ_2016_2020 = normalize(Econ_2016_2020, method = 'range', range = c(0,1)),
#          Vul_2011_2015 = Exposure_2011_2015 - Econ_2011_2015,
#          Vul_2011_2015 = normalize(Vul_2011_2015, method = 'range', range = c(0,1)),
#          Vul_2016_2020 = Exposure_2016_2020 - Econ_2016_2020,
#          Vul_2016_2020 = normalize(Vul_2016_2020, method = 'range', range = c(0,1)),
#          VulPop_2011_2015 = Exposure_2011_2015 - Econ_2011_2015 + Population_2015_log_norm,
#          VulPop_2011_2015 = normalize(VulPop_2011_2015, method = 'range', range = c(0, 1)),
#          VulPop_2016_2020 = Exposure_2016_2020 - Econ_2016_2020 + Population_2020_log_norm,
#          VulPop_2016_2020 = normalize(VulPop_2016_2020, method = 'range', range = c(0, 1)),
#          VulPopSh_2011_2015 = Vul_2011_2015 * Population_2015_log,
#          VulPopSh_2011_2015 = normalize(VulPopSh_2011_2015, method = 'range', range = c(0, 1)),
#          VulPopSh_2016_2020 = Vul_2016_2020 * Population_2020_log,
#          VulPopSh_2016_2020 = normalize(VulPopSh_2016_2020, method = 'range', range = c(0, 1))) %>%
#   dplyr::select(c(ID_ADM, WB_ADM0_NA,
#                   pm25_2000, pm25_2005, pm25_2010, pm25_2015, pm25_2019,
#                   flood_2005, flood_2010, flood_2015, flood_2020,
#                   quake_2005, quake_2010, quake_2015, quake_2020,
#                   loss_2005, loss_2010, loss_2015, loss_2020,
#                   precip_2005, precip_2010, precip_2015, precip_2020,
#                   temp_2005, temp_2010, temp_2015, temp_2020,
#                   drought_2001, drought_2005, drought_2010, drought_2015, drought_2020,
#                   crop_2001, crop_2005, crop_2010, crop_2015, crop_2020,
#                   ntl_2015, ntl_2020,
#                   Population_2015_log, Population_2015_log_norm, Population_2020_log, Population_2020_log_norm,
#                   Exposure_2000_2005, Exposure_2006_2010, Exposure_2011_2015, Exposure_2016_2020,
#                   Econ_2011_2015, Econ_2016_2020, Vul_2011_2015, Vul_2016_2020,
#                   VulPop_2011_2015, VulPop_2016_2020, VulPopSh_2011_2015, VulPopSh_2016_2020)) %>%
#   st_drop_geometry()
# 
# write_csv(indices_ALL, paste0(dir_out, '/Index/Vul_Indicators_ADM2_std.csv'))

indices_ALL <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_std.csv'))

shape_map <- shape %>%
  filter(WB_ADM0_NA != 'Israel') %>%
  left_join(indices_ALL, by = 'ID_ADM')

# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2000_2005, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2000 - 2005)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2006_2010, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2006 - 2010)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))

# Economic Activity
shape_map$map_var <- breaks_fun(shape_map$Econ_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Purples')
map_fun(shape_map, 
        TITLE = 'Economic Activity Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of cropland coverage and nightlight intensity.', 
        LEGEND = 'Relative Economic Activity Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
# Economic Activity
shape_map$map_var <- breaks_fun(shape_map$Econ_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Purples')
map_fun(shape_map, 
        TITLE = 'Economic Activity Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of cropland coverage and nightlight intensity.', 
        LEGEND = 'Relative Economic Activity Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))

# Vulnerability Index
shape_map$map_var <- breaks_fun(shape_map$Vul_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
# Vulnerability Index
shape_map$map_var <- breaks_fun(shape_map$Vul_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))

# Vulnerability Index with population 2015
shape_map$map_var <- breaks_fun(shape_map$VulPop_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability with Total Population (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity + Population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
# Vulnerability Index with population 2020
shape_map$map_var <- breaks_fun(shape_map$VulPop_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability with Total Population (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity + Population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))

# Vulnerability Index weighted by population 2015 log
shape_map$map_var <- breaks_fun(shape_map$VulPopSh_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability weighted by Population (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value of Vulnerability Index weighted by population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
# Vulnerability Index weighted by population 2020 log
shape_map$map_var <- breaks_fun(shape_map$VulPopSh_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability weighted by Population (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value of Vulnerability Index weighted by population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Standardized/'))
```

```{r agg_index_win, eval = F}
# Create winsorization function
# WIN_FUN <- function (VAR, LOW = -2, HIGH = 2){
#   VAR[VAR < LOW] <- LOW
#   VAR[VAR > HIGH] <- HIGH
#   VAR
# }
# 
# indices_ALL <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_original.csv'))
# indices_ALL <- left_join(shape, indices_ALL, by = c('ID_ADM')) %>%
#   filter(WB_ADM0_NA != 'Israel') %>%
#   mutate(pm25_2000 = normalize(pm25_mean_2000, method = 'standardize'),
#          pm25_2005 = normalize(pm25_mean_2005, method = 'standardize'),
#          pm25_2010 = normalize(pm25_mean_2010, method = 'standardize'),
#          pm25_2015 = normalize(pm25_mean_2015, method = 'standardize'),
#          pm25_2019 = normalize(pm25_mean_2019, method = 'standardize'),
#          flood_2005 = normalize(FLOOD_2001_2005, method = 'standardize'),
#          flood_2010 = normalize(FLOOD_2006_2010, method = 'standardize'),
#          flood_2015 = normalize(FLOOD_2011_2015, method = 'standardize'),
#          flood_2020 = normalize(FLOOD_2016_2020, method = 'standardize'),
#          quake_2005 = normalize(QUAKE_2001_2005, method = 'standardize'),
#          quake_2010 = normalize(QUAKE_2006_2010, method = 'standardize'),
#          quake_2015 = normalize(QUAKE_2011_2015, method = 'standardize'),
#          quake_2020 = normalize(QUAKE_2016_2020, method = 'standardize'),
#          loss_2005 = normalize(Loss_sqkm_2001_2005, method = 'standardize'),
#          loss_2010 = normalize(Loss_sqkm_2006_2010, method = 'standardize'),
#          loss_2015 = normalize(Loss_sqkm_2011_2015, method = 'standardize'),
#          loss_2020 = normalize(Loss_sqkm_2016_2020, method = 'standardize'),
#          precip_2005 = normalize(PRECIP_DIFF_2001_2005, method = 'standardize'),
#          precip_2010 = normalize(PRECIP_DIFF_2006_2010, method = 'standardize'),
#          precip_2015 = normalize(PRECIP_DIFF_2011_2015, method = 'standardize'),
#          precip_2020 = normalize(PRECIP_DIFF_2016_2020, method = 'standardize'),
#          temp_2005 = normalize(TEMP_DIFF_2000_2005, method = 'standardize'),
#          temp_2010 = normalize(TEMP_DIFF_2006_2010, method = 'standardize'),
#          temp_2015 = normalize(TEMP_DIFF_2011_2015, method = 'standardize'),
#          temp_2020 = normalize(TEMP_DIFF_2016_2020, method = 'standardize'),
#          drought_2001 = normalize(CDI_2001_mean, method = 'standardize'),
#          drought_2005 = normalize(CDI_2005_mean, method = 'standardize'),
#          drought_2010 = normalize(CDI_2010_mean, method = 'standardize'),
#          drought_2015 = normalize(CDI_2015_mean, method = 'standardize'),
#          drought_2020 = normalize(CDI_2020_mean, method = 'standardize'),
#          # winsorize
#          pm25_2000 = WIN_FUN(pm25_2000),
#          pm25_2005 = WIN_FUN(pm25_2005),
#          pm25_2010 = WIN_FUN(pm25_2010),
#          pm25_2015 = WIN_FUN(pm25_2015),
#          pm25_2019 = WIN_FUN(pm25_2019),
#          flood_2005 = WIN_FUN(flood_2005),
#          flood_2010 = WIN_FUN(flood_2010),
#          flood_2015 = WIN_FUN(flood_2015),
#          flood_2020 = WIN_FUN(flood_2020),
#          quake_2005 = WIN_FUN(quake_2005),
#          quake_2010 = WIN_FUN(quake_2010),
#          quake_2015 = WIN_FUN(quake_2015),
#          quake_2020 = WIN_FUN(quake_2020),
#          loss_2005 = WIN_FUN(loss_2005),
#          loss_2010 = WIN_FUN(loss_2010),
#          loss_2015 = WIN_FUN(loss_2015),
#          loss_2020 = WIN_FUN(loss_2020),
#          precip_2005 = WIN_FUN(precip_2005),
#          precip_2010 = WIN_FUN(precip_2010),
#          precip_2015 = WIN_FUN(precip_2015),
#          precip_2020 = WIN_FUN(precip_2020),
#          temp_2005 = WIN_FUN(temp_2005),
#          temp_2010 = WIN_FUN(temp_2010),
#          temp_2015 = WIN_FUN(temp_2015),
#          temp_2020 = WIN_FUN(temp_2020),
#          drought_2001 = WIN_FUN(drought_2001),
#          drought_2005 = WIN_FUN(drought_2005),
#          drought_2010 = WIN_FUN(drought_2010),
#          drought_2015 = WIN_FUN(drought_2015),
#          drought_2020 = WIN_FUN(drought_2020),
#          Exposure_2000_2005 = pm25_2005 + flood_2005 + quake_2005 + loss_2005 + precip_2005 + temp_2005 + drought_2005,
#          Exposure_2000_2005 = normalize(Exposure_2000_2005, method = 'range', range = c(0,1)),
#          Exposure_2006_2010 = pm25_2010 + flood_2010 + quake_2010 + loss_2010 + precip_2010 + temp_2010 + drought_2010,
#          Exposure_2006_2010 = normalize(Exposure_2006_2010, method = 'range', range = c(0,1)),
#          Exposure_2011_2015 = pm25_2015 + flood_2015 + quake_2015 + loss_2015 + precip_2015 + temp_2015 + drought_2015,
#          Exposure_2011_2015 = normalize(Exposure_2011_2015, method = 'range', range = c(0,1)),
#          Exposure_2016_2020 = pm25_2019 + flood_2020 + quake_2020 + loss_2020 + precip_2020 + temp_2020 + drought_2020,
#          Exposure_2016_2020 = normalize(Exposure_2016_2020, method = 'range', range = c(0,1)),
#          crop_2001 = normalize(Cropland_2001, method = 'standardize'),
#          crop_2005 = normalize(Cropland_2005, method = 'standardize'),
#          crop_2010 = normalize(Cropland_2010, method = 'standardize'),
#          crop_2015 = normalize(Cropland_2015, method = 'standardize'),
#          crop_2020 = normalize(Cropland_2020, method = 'standardize'),
#          ntl_2015 = normalize(NTL_mean_2015, method = 'standardize'),
#          ntl_2020 = normalize(NTL_mean_2020, method = 'standardize'),
#          # winsorize
#          crop_2001 = WIN_FUN(crop_2001),
#          crop_2005 = WIN_FUN(crop_2005),
#          crop_2010 = WIN_FUN(crop_2010),
#          crop_2015 = WIN_FUN(crop_2015),
#          crop_2020 = WIN_FUN(crop_2020),
#          ntl_2015 = WIN_FUN(ntl_2015),
#          ntl_2020 = WIN_FUN(ntl_2020),
#          Population_2015_log = log(POP_mean_2015),
#          Population_2015_log_norm = normalize(Population_2015_log, method = 'range', range = c(0,1)),
#          Population_2020_log = log(POP_mean_2020),
#          Population_2020_log_norm = normalize(Population_2020_log, method = 'range', range = c(0,1)),
#          Econ_2011_2015 = crop_2015 + ntl_2015,
#          Econ_2011_2015 = normalize(Econ_2011_2015, method = 'range', range = c(0,1)),
#          Econ_2016_2020 = crop_2020 + ntl_2020,
#          Econ_2016_2020 = normalize(Econ_2016_2020, method = 'range', range = c(0,1)),
#          Vul_2011_2015 = Exposure_2011_2015 - Econ_2011_2015,
#          Vul_2011_2015 = normalize(Vul_2011_2015, method = 'range', range = c(0,1)),
#          Vul_2016_2020 = Exposure_2016_2020 - Econ_2016_2020,
#          Vul_2016_2020 = normalize(Vul_2016_2020, method = 'range', range = c(0,1)),
#          VulPop_2011_2015 = Exposure_2011_2015 - Econ_2011_2015 + Population_2015_log_norm,
#          VulPop_2011_2015 = normalize(VulPop_2011_2015, method = 'range', range = c(0, 1)),
#          VulPop_2016_2020 = Exposure_2016_2020 - Econ_2016_2020 + Population_2020_log_norm,
#          VulPop_2016_2020 = normalize(VulPop_2016_2020, method = 'range', range = c(0, 1)),
#          VulPopSh_2011_2015 = Vul_2011_2015 * Population_2015_log,
#          VulPopSh_2011_2015 = normalize(VulPopSh_2011_2015, method = 'range', range = c(0, 1)),
#          VulPopSh_2016_2020 = Vul_2016_2020 * Population_2020_log,
#          VulPopSh_2016_2020 = normalize(VulPopSh_2016_2020, method = 'range', range = c(0, 1))) %>%
#   dplyr::select(c(ID_ADM, WB_ADM0_NA,
#                   pm25_2000, pm25_2005, pm25_2010, pm25_2015, pm25_2019,
#                   flood_2005, flood_2010, flood_2015, flood_2020,
#                   quake_2005, quake_2010, quake_2015, quake_2020,
#                   loss_2005, loss_2010, loss_2015, loss_2020,
#                   precip_2005, precip_2010, precip_2015, precip_2020,
#                   temp_2005, temp_2010, temp_2015, temp_2020,
#                   drought_2001, drought_2005, drought_2010, drought_2015, drought_2020,
#                   crop_2001, crop_2005, crop_2010, crop_2015, crop_2020,
#                   ntl_2015, ntl_2020,
#                   Population_2015_log, Population_2015_log_norm, Population_2020_log, Population_2020_log_norm,
#                   Exposure_2000_2005, Exposure_2006_2010, Exposure_2011_2015, Exposure_2016_2020,
#                   Econ_2011_2015, Econ_2016_2020, Vul_2011_2015, Vul_2016_2020,
#                   VulPop_2011_2015, VulPop_2016_2020, VulPopSh_2011_2015, VulPopSh_2016_2020)) %>%
#   st_drop_geometry()
# 
# write_csv(indices_ALL, paste0(dir_out, '/Index/Vul_Indicators_ADM2_win.csv'))

indices_ALL <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_win.csv'))

shape_map <- shape %>%
  filter(WB_ADM0_NA != 'Israel') %>%
  left_join(indices_ALL, by = 'ID_ADM')

# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2000_2005, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2000 - 2005)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2006_2010, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2006 - 2010)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
# Natural Exposure Total
shape_map$map_var <- breaks_fun(shape_map$Exposure_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Greens')
map_fun(shape_map, 
        TITLE = 'Exposure Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of exposure to PM2.5, flood risk, earthquake risk, drought risk, forst loss, and precipitation and temperature variation.', 
        LEGEND = 'Relative Exposure Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))

# Economic Activity
shape_map$map_var <- breaks_fun(shape_map$Econ_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Purples')
map_fun(shape_map, 
        TITLE = 'Economic Activity Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of cropland coverage and nightlight intensity.', 
        LEGEND = 'Relative Economic Activity Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
# Economic Activity
shape_map$map_var <- breaks_fun(shape_map$Econ_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- brewer.pal(7, 'Purples')
map_fun(shape_map, 
        TITLE = 'Economic Activity Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Rescaled sum of cropland coverage and nightlight intensity.', 
        LEGEND = 'Relative Economic Activity Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))

# Vulnerability Index
shape_map$map_var <- breaks_fun(shape_map$Vul_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability Index (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
# Vulnerability Index
shape_map$map_var <- breaks_fun(shape_map$Vul_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability Index (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))

# Vulnerability Index with population 2015
shape_map$map_var <- breaks_fun(shape_map$VulPop_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability with Total Population (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity + Population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
# Vulnerability Index with population 2020
shape_map$map_var <- breaks_fun(shape_map$VulPop_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability with Total Population (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value by: Vulnerability = Exposure - Economic Activity + Population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))

# Vulnerability Index weighted by population 2015 log
shape_map$map_var <- breaks_fun(shape_map$VulPopSh_2011_2015, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability weighted by Population (2011 - 2015)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value of Vulnerability Index weighted by population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
# Vulnerability Index weighted by population 2020 log
shape_map$map_var <- breaks_fun(shape_map$VulPopSh_2016_2020, breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1)
COLOR <- rev(brewer.pal(7, 'PuOr'))
map_fun(shape_map, 
        TITLE = 'Vulnerability weighted by Population (2016 - 2020)', 
        SOURCE = '', 
        NOTE = 'Note: Rescaled value of Vulnerability Index weighted by population. \n A higher value represents a higher vulnerability.', 
        LEGEND = 'Relative Vulnerability Index',
        DIR = paste0(dir_fig, 'MENA/Vul/Winsorized/'))
```

```{r cropland_MAR_EGY}
indices_ALL_original <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_original.csv')) 

shape_map <- left_join(shape, indices_ALL_original, by = 'ID_ADM') %>%
  dplyr::select(c(ID_ADM, WB_ADM0_NA, starts_with('Cropland')))

TITLE_LIST <- c('MODIS Cropland Cover 2001', 'MODIS Cropland Cover 2005', 'MODIS Cropland Cover 2010', 
                'MODIS Cropland Cover 2015', 'MODIS Cropland Cover 2020')

for (COUNTRY in c('Morocco', 'Arab Republic of Egypt')) {
  
  shape_map_sub <- shape_map %>%
    filter(WB_ADM0_NA == COUNTRY)
  
  shape_0_sub = shape_0 %>%
    filter(WB_ADM0_NA == COUNTRY)
  
  for (YEAR in c(2001, 2005, 2010, 2015, 2020)) {
    
    shape_map_sub <- shape_map_sub %>%
      mutate(map_var = breaks_fun(get(paste0('Cropland_', YEAR)), style = 'fisher', breaks = 5, dig = 0))

    COLOR <- brewer.pal(5, 'Blues')
    
    map_fun(SHAPE = shape_map_sub, 
            SHAPE_0 = shape_0_sub, 
            TITLE = paste0(COUNTRY, ' Cropland Cover ', YEAR), 
            SOURCE = 'MODIS', 
            NOTE = '', 
            LEGEND = 'Cropland (#pixels)',
            DIR = paste0(dir_fig, 'Case studies/', COUNTRY, '/'))
    print(paste0('DONE: ', COUNTRY, ' Cropland Cover ', YEAR))
  }
}
```

```{r cropland_LEVANT_YEM}
indices_ALL_win <- read_csv(paste0(dir_out, '/Index/Vul_Indicators_ADM2_win.csv')) %>%
  dplyr::select(-WB_ADM0_NA)

shape_map <- left_join(shape, indices_ALL_win, by = 'ID_ADM') %>%
  dplyr::select(c(ID_ADM, WB_ADM0_NA, starts_with('Vul')))

TITLE_LIST <- c('Vulnerability (2011 - 2015)', 'Vulnerability (2016 - 2020)', 
                'Vulnerability with Total Population (2011 - 2015)', 'Vulnerability with Total Population (2016 - 2020)',
                'Vulnerability weighted by Population (2011 - 2015)', 'Vulnerability weighted by Population (2016 - 2020)')
VAR_LIST <- c('Vul_2011_2015', 'Vul_2016_2020', 
              'VulPop_2011_2015', 'VulPop_2016_2020', 
              'VulPopSh_2011_2015', 'VulPopSh_2016_2020')

for (COUNTRY in c('Jordan', 'Lebanon', 'Syrian Arab Republic', 'West Bank and Gaza', 'Republic of Yemen')) {
  
  shape_map_sub <- shape_map %>%
    filter(WB_ADM0_NA == COUNTRY)
  
  shape_0_sub = shape_0 %>%
    filter(WB_ADM0_NA == COUNTRY)
  
  for (i in 1:length(TITLE_LIST)) {
    
    shape_map_sub <- shape_map_sub %>%
      mutate(map_var = breaks_fun(get(VAR_LIST[i]), breaks = 7, dig = 2, style = 'fixed', LOW = 0, HIGH = 1))

    COLOR <- rev(brewer.pal(7, 'PuOr'))
    
    map_fun(SHAPE = shape_map_sub, 
            SHAPE_0 = shape_0_sub, 
            TITLE = paste0(COUNTRY, ' ', TITLE_LIST[i]), 
            SOURCE = '', 
            NOTE = 'Note: Rescaled value of Vulnerability Index weighted by population. \n A higher value represents a higher vulnerability.', 
            LEGEND = 'Relative Vulnerability Index',
            DIR = paste0(dir_fig, 'Case studies/', COUNTRY, '/'))
    print(paste0('DONE: ', COUNTRY, ' ', TITLE_LIST[i]))
  }
}
```