---
title: 'Temperature'
author: 'Liang Cai'
date: "2022/11/24"
output: html_document
---
# Define the working directory for the entire markdown file to enable relative path
```{r setup, include=FALSE}
rm(list=ls())

#Define relative path
knitr::opts_knit$set(root.dir = '/Users/ashitakarl/Dropbox/WB/MENA_WorldBank/')
knitr::opts_chunk$set(echo = TRUE)
```

#Load packages
```{r}
library(raster)
library(terra)
library(tidyverse)
library(ggplot2)
library(sf)
library(ncdf4)
```

#Define data directories

```{r}
#Confirm path
dir_shp <- './Boundaries/'                                                                                                            #Confirm path
dir_temp <- '/Users/ashitakarl/Desktop/Project/WB/Raw data/Temperature 2000-2022/'                    #Confirm path
dir_index <- './Index/'    
CRS_WGS <- '+proj=longlat +datum=WGS84 +no_defs'
```

#Include functions for clipping and extract values
```{r}
#Function to extract values
desc_stats_fun <- function(clipped, shp){   
  
    # Estimate basic stats per rayon
    stats <- terra::extract(x = clipped, y = shp, touches= T, na.rm = T, df = TRUE)
    
    colnames(stats)[1:2] <- c('ID', 'value')
  
    desc_stats <- stats %>%
      group_by(ID) %>% 
      summarise(mean = mean(value, na.rm=TRUE), 
                max = max(value, na.rm=TRUE), 
                min = min(value, na.rm=TRUE), 
                median = median(value, na.rm=TRUE), 
                std = sd(value, na.rm=TRUE), 
                obs = n())
    
    return(desc_stats)
}
```


```{r}
# Prepare for loop
# Load shapefile
shape <- read_sf(paste0(dir_shp, 'MENA_ADM2.shp')) %>%                            #Change filename  
  st_transform(CRS_WGS) %>%
  st_make_valid() %>%
  # The Number of districts
  mutate(ID = seq.int(1, n()))

shape_df <- shape %>%
  st_drop_geometry() %>%
  dplyr::select(c(ID, ID_ADM))

#PREPARE LOOP OVER MONTHS
months <- c(paste0('0', c(1:9)), 10:12)
years <- seq(2000, 2020, 1)

#Create data frame
df_stat <- data.frame()

#Extract temperature values
for (YEAR in years) {
  
  for(MONTH in months) {
    
    raster <- brick(paste0(dir_temp, 'GLDAS_NOAH10_M.A', YEAR, MONTH, '.021.nc4'), varname = 'SoilMoi0_10cm_inst')
    
    clipped <- terra::crop(raster, shape)
    
    # stats at national level
    df_temp <- desc_stats_fun(clipped, shape) %>%
      mutate(years = YEAR,
             months = MONTH)

    df_stat <- bind_rows(df_stat, df_temp)
    }    
  }

df_stat <- df_stat %>%
  left_join(shape_df, by = 'ID')

month_levels <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

#Create col by month name
df_stat <- df_stat %>%
  mutate(months = as.numeric(months),
         month = month.abb[months],
         month = factor(month, levels = month_levels))
```

```{r}
YEAR_LIST <- c(2000, 2005, 2010, 2015, 2020)
df_full <- shape_df %>%
  dplyr::select(c(ID_ADM))

for (i in 1:(length(YEAR_LIST) - 1)) {
  
  YEAR_BEGIN <- YEAR_LIST[i] + 1
  YEAR_END <- YEAR_LIST[i+1]
  
  df1 <- df_stat %>%
    filter(years >= YEAR_BEGIN & years <= YEAR_END) %>%
    group_by(ID_ADM, month)%>%
    dplyr::summarise(value = mean(mean))

  df2 <- df1 %>%
    group_by(ID_ADM) %>%
    mutate(lag = lag(value)) %>%
    mutate(month.change = (lag - value)) %>%
    ungroup() %>%
    mutate(abs_value= abs(month.change) %>% as.numeric())

  df2 <- df2 %>%
    group_by(ID_ADM)%>%
    mutate(mean_val = mean(abs_value, na.rm = TRUE))

  diff_temp <- df2 %>%
    group_by(ID_ADM) %>%
    dplyr::summarise(average_diff_temp = mean(abs_value, na.rm = TRUE))
  
  colnames(diff_temp)[2] <- paste0('TEMP_DIFF_', YEAR_BEGIN, '_', YEAR_END)
  
  df_full <- left_join(df_full, diff_temp, by = 'ID_ADM')
}

write_csv(df_full, file = paste0(dir_index, "Temperature_ADM2.csv"))
```