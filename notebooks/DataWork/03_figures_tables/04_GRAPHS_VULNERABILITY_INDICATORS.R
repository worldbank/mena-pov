# ================================================================
# Script Name: 03_GRAPH_VULNERABILITY_INDICATORS
# Purpose: Create maps with each vulnerability indicator
# Input Dataset:grid_vul_10km_final.Rds,  MENA_ADM2.shp, MENA_Country.shp
# Author: Chitra Balasubramanian
# Last Updated: 2024-08-05
# ================================================================

options(scipen = 999)


# Load Data ---------------------------------------------------------------
grid_10km <- readRDS(file.path(final_replication, "grid_vul_10km_final.Rds"))

# MENA shapefiles
shp <- st_read(file.path(raw_replication, "BOUNDARIES", "MENA_ADM2.shp"))
country <- st_read(file.path(raw_replication, "BOUNDARIES", "MENA_Country.shp"))



# Define common ggplot theme
common_theme <- ggplot2::theme(
  text = element_text(color = "#22211d"),
  axis.line = element_blank(),
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  plot.title = element_text(hjust = 1),
  plot.subtitle = element_text(hjust = 1),
  plot.caption = element_text(hjust = 1),
  legend.text = element_text(size = 7),
  legend.title = element_text(size = 11)
)

names(grid_10km)








# Aggregate Yield Achievement Ratio ---------------------------------------

# First create the frequency categories
ag_ach_ratio_prj$yield_ach_ratio_freq <- cut(ag_ach_ratio_prj$yield_ach_ratio,
                                             breaks = c(0, 0.0000001, 1, 5, 10, 15, 20, 25, 30, 35, 40),
                                             include.lowest = TRUE, right = FALSE,
                                             labels = c(
                                               "0",
                                               "0-1",
                                               "1-5",
                                               "5-10",
                                               "10-15",
                                               "15-20",
                                               "20-25",
                                               "25-30",
                                               "30-35",
                                               "35-40"
                                             )
)

# Convert to factor and replace "0" with NA, maintaining factor structure
ag_ach_ratio_prj$yield_ach_ratio_freq <- factor(
  ifelse(as.character(ag_ach_ratio_prj$yield_ach_ratio_freq) == "0", NA, 
         as.character(ag_ach_ratio_prj$yield_ach_ratio_freq)),
  levels = c("0-1", "1-5", "5-10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40")
)

# Setup colors
colors <- hcl.colors(9, "RdYlGn")  # Changed to 9 to match number of categories after removing "0"

# Plot
ggplot() +
  geom_sf(data = ag_ach_ratio_prj, aes(fill = yield_ach_ratio_freq), size = 0.01, color = NA) +
  scale_fill_manual(
    values = colors,
    name = "Yield Achievement Ratio",
    na.value = "grey90"  # This will color NA values in grey
  ) +
  geom_sf(data = shp, color = "black", alpha = 0, size = 0.01) +
  geom_sf(data = country, color = "black", alpha = 0, size = 0.3) +
  geom_sf_text(data = country, aes(label = WB_ADM0_NA), size = 2) +
  theme_void() +
  theme(
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(
    label.position = "bottom",
    title.position = "top",
    keywidth = 1,
    keyheight = 0.5,
    nrow = 1,
    direction = "horizontal",
    override.aes = list(color = "black")
  ))


ggsave(filename = file.path(maps, paste0("agg_yield.png")),height = 4, width = 8, units = c("in"))




# Conflict ----------------------------------------------------------------

acled <- grid_10km %>% dplyr::select(grid_id,tot_10yrs_acled_indicator)
acled_prj <- st_transform(acled, crs = 4326)


summary(acled_prj$tot_10yrs_acled_indicator)


acled_prj$tot_10yrs_discrete <- cut(
  acled_prj$tot_10yrs_acled_indicator,
  #### Note: Update breaks and labels
  breaks = c(-Inf, 0.0001, 2, 4, 6, 8, 10, 50, 100, 500, 1000, 2000, 3000, Inf),
  include.lowest = TRUE,
  right = FALSE,
  labels = c(
    "0",
    "1-2",
    "2-4",
    "4-6",
    "6-8",
    "8-10",
    "10-50",
    "50-100",
    "100-500",
    "500-1000",
    "1000 - 2000",
    "2000-3000",
    "3000+"
  )
)

#Create the plot

ggplot() +
  geom_sf(data = acled_prj,aes(fill = tot_10yrs_discrete), color = NA) +
  geom_sf(data = shp, color="grey27", alpha =0, size=0.01) +
  geom_sf(data = country, color="grey", alpha =0, size=0.3) +
  geom_sf_text(data=country, aes(label = WB_ADM0_NA), size=2, color = "grey") +
  scale_fill_viridis_d( # Use discrete scale from viridis
    option = "rocket", # Specify magma color scheme
    guide = guide_legend(title = "Total Conflict Events (Last 10 years)"),
  ) +
  labs(fill = "Total Conflict Events (Last 10 years)") +
  common_theme +
  theme_void() +
  theme(
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  guides(fill = guide_legend(
    order = 0,
    direction = "horizontal", 
    title.position = "top", 
    label.position = "bottom", 
    nrow = 1, 
    keywidth = 1, 
    keyheight = 0.5
  )
  )

ggsave(
  filename = file.path(maps, "tot_conflict_10yrs.png"),
  height = 4,
  width = 8,
  units = c("in")
)




names(grid_10km)
# Nighttime Lights --------------------------------------------------------
ntl_nogf <- grid_10km %>% dplyr::select(grid_id,nogf_change_in_ntl_2021_2017,nogf_ntl_mean_2021)
ntl_nogf_prj <- st_transform(ntl_nogf, crs = 4326)


##### RAW VALUES ##########################################
#Only gas flares
summary(ntl_nogf_prj$nogf_ntl_mean_2021)

# Discretize the nighttime light intensity data into bins
ntl_nogf_prj$ntl_nogf_intensity_discrete <- cut(
  ntl_nogf_prj$nogf_ntl_mean_2021,
  breaks = c(-Inf, 0.0001, 0.5, 1, 5, 10, 100, 200, 300, 400),
  include.lowest = TRUE,
  right = FALSE,
  labels = c(
    "0",
    "0 - 0.5",
    "0.5-1",
    "1-5",
    "5-10",
    "10-100",
    "100-200",
    "200-300",
    "300+"
  )
)




#without gas flares (raw values 2021)
ntl_nogf_prj <- st_transform(ntl_nogf, 4326)

summary(ntl_nogf_prj$nogf_change_in_ntl_2021_2017)


# Convert the change into three categories :
ntl_nogf_prj <- ntl_nogf_prj %>%
  dplyr::mutate(
    ntl_change_category = case_when(
      nogf_change_in_ntl_2021_2017 < 0 ~ "Decline in NTL",
      nogf_change_in_ntl_2021_2017  == 0 ~ "No Change in NTL",
      nogf_change_in_ntl_2021_2017 > 0 ~ "Increase in NTL"
    )
  )

custom_colors <- c(
  "Decline in NTL" = "#4e2a6a",   # Medium Purple
  "No Change in NTL" = "#000004",  # Black
  "Increase in NTL" = "#ca2801"    # Pinkish Red
)

ggplot() +
  geom_sf(data = ntl_nogf_prj,aes(fill = ntl_change_category), color = NA) +
  geom_sf(data = shp, color="black", alpha =0, size=0.01) +
  geom_sf(data = country, color="black", alpha =0, size=0.3) +
  geom_sf_text(data=country, aes(label = WB_ADM0_NA), size=2) +
  scale_fill_manual(values = custom_colors) +
  labs(fill = "Change in Nighttime Light Intensity (without gas flares)") +
  common_theme +
  theme_void() +
  theme(
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  guides(fill = guide_legend(
    order = 0,
    direction = "horizontal",
    title.position = "top",
    label.position = "bottom",
    nrow = 1,
    keywidth = 1,
    keyheight = 0.5
  )
  )

ggsave(
  filename = file.path(maps, "ntl_nogf.png"),
  height = 4,
  width = 8,
  units = c("in")
)





# Forest Loss -------------------------------------------------------------
forest_loss <- grid_10km %>% dplyr::select(grid_id,loss_category)


forest_loss_prj <- st_transform(forest_loss, crs = 4326)
# summary(forest_loss_prj$loss_category)
# forest_loss_prj$loss_category <- ifelse(forest_loss_prj$forest_loss>0,1,0)
# # Convert loss_category to a factor
# forest_loss_prj$loss_category <- factor(forest_loss_prj$loss_category, labels = c("No Forest Cover Loss", "Forest Cover Loss"))



# Create the plot
ggplot() +
  geom_sf(data = shp, color="lightgrey", alpha =0, size=0.01) +
  geom_sf(data = forest_loss_prj, aes(fill = loss_category), size = 0.01, col = NA) +
  scale_fill_manual(
    values = c("No Forest Cover Loss" = "white", "Forest Cover Loss" = "sienna4"),
    name = "Forest Loss During 2000-2022"
  ) +
  geom_sf(data = shp, color="black", alpha =0, size=0.01) +
  geom_sf(data = country, color="black", alpha =0, size=0.3) +
  geom_sf_text(data=country, aes(label = WB_ADM0_NA), size=2) +
  common_theme +
  theme_void() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(label.position = "bottom", 
                             title.position = "top", 
                             keywidth = 1, 
                             keyheight = 0.5, 
                             nrow = 1,
                             direction = "horizontal",
                             override.aes = list(color = "black")))


ggsave(
  filename = file.path(maps, paste0("forest_loss.png")),
  height = 4,
  width = 8,
  units = c("in")
)







names(grid_10km)
# Travel Time (Health) ----------------------------------------------------
tt_mena <- grid_10km %>% dplyr::select(grid_id,min_tt_health)
tt_mena_prj <- st_transform(tt_mena,4326)

# Identify infinite values
inf_indices <- which(is.infinite(tt_mena_prj$min_tt_health))

# Replace infinite values with NA, assuming 'inf_indices' has unique values
if (length(unique(inf_indices)) == length(inf_indices)) {
  tt_mena_prj$min_tt_health[inf_indices] <- NA
} else {
  # Handle the case where 'inf_indices' might not be unique
  warning("Found duplicated indices when trying to replace infinite values.")
}


# Create a binned factor for min_tt_health with specific breaks and labels
tt_mena_prj$min_tt_health_binned <- cut(
  tt_mena_prj$min_tt_health,
  breaks = c(-Inf, 10, 20, 30, 40, 50, 60, Inf),
  labels = c("0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60+"),
  right = FALSE # This makes the intervals left-closed, right-open
)

# Basic choropleth map with adjustments
ggplot() +
  geom_sf(data = tt_mena_prj,aes(fill = min_tt_health_binned), color = NA) +
  geom_sf(data = shp, color="grey27", alpha =0, size=0.01) +
  geom_sf(data = country, color="grey", alpha =0, size=0.3) +
  geom_sf_text(data=country, aes(label = WB_ADM0_NA), size=2) +
  scale_fill_viridis_d( # Use discrete scale from viridis
    option = "viridis", # Specify magma color scheme
    guide = guide_legend(title = "Travel Time (min)"),
    direction = -1 # Reverse the color scale, if needed
  ) +
  labs(fill = "Travel Time to nearest health facility (min)") +
  common_theme +
  theme_void() +
  theme(
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  guides(fill = guide_legend(
    order = 0,
    direction = "horizontal", 
    title.position = "top", 
    label.position = "bottom", 
    nrow = 1, 
    keywidth = 1, 
    keyheight = 0.5,
    override.aes = list(color = "black")
  )
  )

ggsave(
  filename = file.path(maps,"tt_health_mena.png"),
  height = 4,
  width = 8,
  units = c("in")
)







# Travel Time (Education) -------------------------------------------------
tt_mena <- grid_10km %>% dplyr::select(grid_id, min_tt_educ)


tt_mena_prj <- st_transform(tt_mena,4326)

# Identify infinite values
inf_indices <- which(is.infinite(tt_mena_prj$min_tt_educ))

# Replace infinite values with NA, assuming 'inf_indices' has unique values
if (length(unique(inf_indices)) == length(inf_indices)) {
  tt_mena_prj$min_tt_educ[inf_indices] <- NA
} else {
  # Handle the case where 'inf_indices' might not be unique
  warning("Found duplicated indices when trying to replace infinite values.")
}


# Create a binned factor for min_tt_health with specific breaks and labels
tt_mena_prj$min_tt_educ_binned <- cut(
  tt_mena_prj$min_tt_educ,
  breaks = c(-Inf, 10, 20, 30, 40, 50, 60, Inf),
  labels = c("0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60+"),
  right = FALSE # This makes the intervals left-closed, right-open
)

# Basic choropleth map with adjustments
ggplot() +
  geom_sf(data = tt_mena_prj,aes(fill = min_tt_educ_binned), color = NA) +
  geom_sf(data = shp, color="grey27", alpha =0, size=0.01) +
  geom_sf(data = country, color="grey", alpha =0, size=0.3) +
  geom_sf_text(data=country, aes(label = WB_ADM0_NA), size=2) +
  scale_fill_viridis_d( # Use discrete scale from viridis
    option = "viridis", # Specify magma color scheme
    guide = guide_legend(title = "Travel Time (min)"),
    direction = -1 # Reverse the color scale, if needed
  ) +
  labs(fill = "Travel Time to nearest educational facility (min)") +
  common_theme +
  theme_void() +
  theme(
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  guides(fill = guide_legend(
    order = 0,
    direction = "horizontal", 
    title.position = "top", 
    label.position = "bottom", 
    nrow = 1, 
    keywidth = 1, 
    keyheight = 0.5,
    override.aes = list(color = "black")
  )
  )

ggsave(
  filename = file.path(maps, "tt_educ_mena.png"),
  height = 4,
  width = 8,
  units = c("in")
)







# Travel Time (Markets) ---------------------------------------------------
tt_mena <- grid_10km %>% dplyr::select(grid_id, min_tt_markets)
tt_mena_prj <- st_transform(tt_mena,4326)

# Identify infinite values
inf_indices <- which(is.infinite(tt_mena_prj$min_tt_markets))



# Replace infinite values with NA, assuming 'inf_indices' has unique values
if (length(unique(inf_indices)) == length(inf_indices)) {
  tt_mena_prj$min_tt_markets[inf_indices] <- NA
} else {
  # Handle the case where 'inf_indices' might not be unique
  warning("Found duplicated indices when trying to replace infinite values.")
}


# Create a binned factor for min_tt_health with specific breaks and labels
tt_mena_prj$min_tt_markets_binned <- cut(
  tt_mena_prj$min_tt_markets,
  breaks = c(-Inf, 10, 20, 30, 40, 50, 60, Inf),
  labels = c("0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60+"),
  right = FALSE # This makes the intervals left-closed, right-open
)

# Basic choropleth map with adjustments
ggplot() +
  geom_sf(data = tt_mena_prj,aes(fill = min_tt_markets_binned), color = NA) +
  geom_sf(data = shp, color="grey27", alpha =0, size=0.01) +
  geom_sf(data = country, color="grey", alpha =0, size=0.3) +
  geom_sf_text(data=country, aes(label = WB_ADM0_NA), size=2) +
  scale_fill_viridis_d( # Use discrete scale from viridis
    option = "viridis", # Specify magma color scheme
    guide = guide_legend(title = "Travel Time (min)"),
    direction = -1 # Reverse the color scale, if needed
  ) +
  labs(fill = "Travel Time to nearest market(seaport, airport or city) (min)") +
  common_theme +
  theme_void() +
  theme(
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  guides(fill = guide_legend(
    order = 0,
    direction = "horizontal", 
    title.position = "top", 
    label.position = "bottom", 
    nrow = 1, 
    keywidth = 1, 
    keyheight = 0.5,
    override.aes = list(color = "black")
  )
  )

ggsave(
  filename = file.path(maps,"tt_markets_mena.png"),
  height = 4,
  width = 8,
  units = c("in")
)








# Vulnerability Dimension Share -------------------------------------------
grid_sf_vul_prj <- st_transform(grid_10km,4326)
summary(grid_sf_vul_prj$vul_share)



# Defining categorical data
grid_sf_vul_prj$vulnerable_freq <-
  cut(
    grid_sf_vul_prj$vul_share,
    breaks = c(0, 0.1, 0.2, 0.5, 0.8, 1),
    include.lowest = TRUE,
    right = FALSE
  )

# Adjusting the number of colors to match the number of bins
colors <- rev(hcl.colors(5, "RdYlGn"))  # Using 5 colors for 5 bins

# Basic choropleth map
ggplot() +
  geom_sf(data = grid_sf_vul_prj, aes(fill = vulnerable_freq), color = NA) +
  geom_sf(data = shp, color = "grey27", alpha = 0, size = 0.01) +
  geom_sf(data = country, color = "grey", alpha = 0, size = 0.3) +
  geom_sf_text(data = country, aes(label = WB_ADM0_NA), size = 2) +
  scale_fill_manual( # Apply the custom color scale
    values = colors,
    guide = guide_legend(title = "Share of Vulnerability"),
    labels = c( "0 - 0.1", "0.1 - 0.2", "0.2 - 0.5", "0.5 - 0.8", "0.8 - 1")
  ) +
  labs(fill = "Share of Vulnerability") +
  theme_void() +  # Simplifies the plot by removing background, grid lines, and axes
  theme(
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  guides(fill = guide_legend(
    order = 0,
    direction = "horizontal",
    title.position = "top",
    label.position = "bottom",
    nrow = 1,
    keywidth = 1,
    keyheight = 0.5,
    override.aes = list(color = "black")
  )) +
  common_theme


ggsave(
  filename = file.path(maps, paste0("vul_share.png")),
  height = 4 ,
  width = 8,
  units = c("in")
)


# ############################################################
# # VULNERABILITY DIMENSION SUMS ---------------------------------------
# ############################################################
# 
# grid_sf_vul_prj <- st_transform(grid_sf_vul,4326)
# summary(grid_sf_vul_prj$vul_dim_sum_without_na)
# 
# 
# # Defining categorical data
# grid_sf_vul_prj$vulnerable_freq_notNA <-
#   cut(
#     grid_sf_vul_prj$vul_dim_sum_without_na,
#     breaks = c(0,1,2,3,4,5,6,7),
#     include.lowest = TRUE,
#     right = FALSE
#   )
# 
# # Adjusting the number of colors to match the number of bins
# colors <- rev(hcl.colors(8, "RdYlGn"))
# 
# # Vulnerability ignoring NAs
# ggplot() +
#   geom_sf(data = grid_sf_vul_prj, aes(fill = vulnerable_freq_notNA), color = NA) +
#   geom_sf(data = shp, color = "grey27", alpha = 0, size = 0.01) +
#   geom_sf(data = country, color = "grey", alpha = 0, size = 0.3) +
#   geom_sf_text(data = country, aes(label = WB_ADM0_NA), size = 2) +
#   scale_fill_manual( # Apply the custom color scale
#     values = colors,
#     guide = guide_legend(title = "Vulnerability Dimensions (cumulative"),
#     labels = c( "0-1", "1-2", "2 - 3", "3-4","4-5","5-6","6-7")
#   ) +
#   labs(fill = "Vulnerability Dimensions (cumulative)") +
#   theme_void() +  # Simplifies the plot by removing background, grid lines, and axes
#   theme(
#     legend.position = "bottom",
#     panel.grid.major = element_blank(),
#     panel.grid.minor = element_blank()
#   ) +
#   guides(fill = guide_legend(
#     order = 0,
#     direction = "horizontal",
#     title.position = "top",
#     label.position = "bottom",
#     nrow = 1,
#     keywidth = 1,
#     keyheight = 0.5,
#     override.aes = list(color = "black")
#   )) + 
#   common_theme  
# 
# ggsave(
#   filename = file.path(maps, paste0("vul_dim_sum.png")),
#   height = 12,
#   width = 16,
#   units = c("in")
# )
