# ================================================================
# Script Name: 11_GRAPH_COMPOSITION_VULNERABILITY
# Purpose: Create map of exposed, poor and vulnerable
# Input Dataset: ,  MENA_ADM2.shp, MENA_Country.shp
# Author: Chitra Balasubramanian
# Last Updated: 2024-08-05
# ================================================================


# Load Data ---------------------------------------------------------------

poor_vul_exposed <- readRDS(file.path(final_replication,"grid_10km_poor_vul_exposed.Rds"))
grid_sf <- readRDS(file.path(final_replication, "grid_vul_10km_final.Rds"))

vul_pop_sub_prj <- st_transform(grid_sf,4326)




# Breakdown of sub-regions (vul_share > 0.3) --------------------------------

vul_share_adm1 <- vul_pop_sub_prj %>%
  filter(ISO_A2 != "MT") %>%
  group_by(WB_ADM1_NA, ISO_A2) %>%
  dplyr::summarise(
    vul_share_adm1 = mean(vul_share, na.rm = T),
    pop_count_adm1 = sum(pop_count, na.rm = T),
    vul_thresh_region = first(vul_thresh_region)
  ) %>%
  dplyr::mutate(name = paste0(WB_ADM1_NA,",",ISO_A2))

vul_share_high <- vul_share_adm1 %>% dplyr::filter(vul_share_adm1 > vul_thresh_region)


# Composition of dimensions within the high share regions -----------------

comp_vul <- vul_pop_sub_prj %>%
  dplyr::filter(WB_ADM1_NA %in% vul_share_high$WB_ADM1_NA) %>%
  dplyr::select(ISO_A2, WB_ADM1_NA,exp_dim,agg_yield_ratio_thresh,
                forest_loss_thresh,ntl_nogf_thresh,ntl_gf_thresh,conflict_thresh,
                tt_health_thresh,tt_educ_thresh,tt_markets_thresh,pop_count)



comp_vul_summ <- comp_vul %>%
  group_by(WB_ADM1_NA, ISO_A2) %>%
  dplyr::summarize(
    pop_count_adm1 = sum(pop_count, na.rm = T),
    tot_grid_cells_vul = sum(c_across(c(ends_with("thresh"),exp_dim)), na.rm = TRUE),
    tot_grid_cells_agg_yield_ratio = sum(agg_yield_ratio_thresh, na.rm = TRUE),
    tot_grid_cells_forest_loss = sum(forest_loss_thresh, na.rm = TRUE),
    tot_grid_cells_ntl_nogf = sum(ntl_nogf_thresh, na.rm = TRUE),
    tot_grid_cells_ntl_gf = sum(ntl_gf_thresh, na.rm = TRUE),
    tot_grid_cells_conflict = sum(conflict_thresh, na.rm = TRUE),
    tot_grid_cells_tt_health = sum(tt_health_thresh, na.rm = TRUE),
    tot_grid_cells_tt_markets = sum(tt_markets_thresh, na.rm = TRUE),
    tot_grid_cells_tt_educ = sum(tt_educ_thresh, na.rm = TRUE),
    tot_grid_cells_hh_dim = sum(exp_dim, na.rm = T)
  ) %>%
  dplyr::mutate(
    share_grid_cells_agg_yield_ratio = tot_grid_cells_agg_yield_ratio / tot_grid_cells_vul,
    share_grid_cells_forest_loss = tot_grid_cells_forest_loss / tot_grid_cells_vul,
    share_grid_cells_ntl_nogf = tot_grid_cells_ntl_nogf / tot_grid_cells_vul,
    share_grid_cells_ntl_gf = tot_grid_cells_ntl_gf / tot_grid_cells_vul,
    share_grid_cells_conflict = tot_grid_cells_conflict / tot_grid_cells_vul,
    share_grid_cells_tt_health = tot_grid_cells_tt_health / tot_grid_cells_vul,
    share_grid_cells_tt_markets = tot_grid_cells_tt_markets / tot_grid_cells_vul,
    share_grid_cells_tt_educ = tot_grid_cells_tt_educ / tot_grid_cells_vul,
    share_grid_cells_hh_dim = tot_grid_cells_hh_dim/tot_grid_cells_vul,
  ) %>%
  dplyr::select(WB_ADM1_NA, ISO_A2, starts_with("share_"),pop_count_adm1) %>%
  st_drop_geometry()


comp_vul_dim_df <- comp_vul_summ %>%
  pivot_longer(
    cols = starts_with("share"),
    names_to = "Category",
    values_to = "Value"
  ) %>%
  dplyr::mutate(
    name = paste0 (WB_ADM1_NA,",", ISO_A2)
  )





# Plot --------------------------------------------------------------------

# Define a unified theme
unified_theme <- theme_ipsum() + 
  theme(legend.position = "right", 
        plot.margin = margin(5, 5, 5, 5, unit = "pt"))

# Define the new color palettes with 7 colors each
plot1_colors <- c(
  "#1d2951", # shade_1
  "#3c4a88", # shade_2
  "#7a71b4", # shade_3
  "#b56298", # shade_4
  "#e6557d", # shade_5
  "#ff8851", # shade_6
  "#ffce85"  # shade_7
)

plot2_colors <- c(
  "#003f5c", # share_grid_cells_agg_yield_ratio
  "#2f4b7c", # share_grid_cells_conflict
  "#665191", # share_grid_cells_forest_loss
  "#a05195", # share_grid_cells_hh_dim
  "#d45087", # share_grid_cells_ntl_nogf
  "#f95d6a", # share_grid_cells_ntl_gf
  "#ff7c43", # share_grid_cells_tt_health
  "#ffa600", # share_grid_cells_tt_markets
  "#DDB771"  # share_grid_cells_tt_educ
)



# Map the color palette to ISO_A2 for the first plot
iso_colors <- plot1_colors
names(iso_colors) <- unique(vul_share_high$ISO_A2)

# Plot 1: Vulnerability Share
plot1 <- ggplot(data = vul_share_high, aes(y = reorder(name, vul_share_adm1), x = vul_share_adm1, size = pop_count_adm1)) +
  geom_point(alpha = 0.7) +
  labs(x = "Share of Vulnerability", y = "") +
  scale_size_continuous(range = c(2, 15), 
                        name = "Population(in millions)",
                        labels = label_number(scale = 1e-6, suffix = "M", accuracy = 0.1)) +
  scale_color_manual(name = "Country", values = iso_colors) +
  unified_theme +
  theme(panel.grid.major.y = element_blank(),  # Remove major grid lines on x-axis
        panel.grid.minor.y = element_blank() )  # Remove minor grid lines on x-axis)
plot1
# Plot 2: Composition of Vulnerability Dimensions
plot2 <- ggplot(comp_vul_dim_df, aes(fill = Category, x = Value, y = name)) + 
  geom_bar(position = "fill", stat = "identity") + 
  geom_text(aes(label = ifelse(percent(Value, accuracy = 1) == "0%", "", percent(Value, accuracy = 1))),
            stat = "identity", 
            position = position_fill(vjust = 0.5), 
            color = "white", size = 3) +  # Specify the text color and size
  scale_fill_manual(
    values = plot2_colors,
    labels = c(
      "share_grid_cells_agg_yield_ratio" = "Yield Gap < 5",
      "share_grid_cells_conflict" = "Conflict Events > 0 (2019-2023)",
      "share_grid_cells_forest_loss" = "Forest Loss (2000-2022)",
      "share_grid_cells_hh_dim" = "Household Surveys (SP & FIN)",
      "share_grid_cells_ntl_nogf" = "NTL Decrease (2017-2021)",
      "share_grid_cells_ntl_gf" = "NTL Gas Flares Decrease(2017-2021)",
      "share_grid_cells_tt_health" = "Travel Time to Health > 1hr",
      "share_grid_cells_tt_markets" = "Travel Time to Markets > 1hr",
      "share_grid_cells_tt_educ" = "Travel Time to Educ > 1hr"
    )
  ) +
  unified_theme + 
  labs(title = "", x = "", y = "", fill = "Vulnerability Dimension")+
  theme(panel.grid.major.y = element_blank(),  # Remove major grid lines on x-axis
        panel.grid.minor.y = element_blank() ) 
plot2
# Combine the plots using ggarrange
combined_plot <- ggarrange(plot1, plot2, ncol = 1, nrow = 2, heights = c(1, 1))
combined_plot

# Save the combined plot
ggsave(
  filename = file.path(graphs, paste0("combined_vul_share_and_comp_vul_dim.png")),
  plot = combined_plot,
  height = 14, # Adjust the height accordingly
  width = 14,
  units = c("in")
)
