# ================================================================
# Script Name: 03_CREATE_VULNERABILITY_THRESHOLD
# Purpose: Creating thresholds that define the "extreme" of 
# each vulnerability indicator
# Input Dataset: grid_10km_people.Rds
# Output Dataset: 
# Author: Chitra Balasubramanian
# Last Updated: 2024-08-05
# ================================================================



# Load Data ---------------------------------------------------------------

grid_sf <- readRDS(file.path(final_replication,"grid_10km_people.Rds"))

names(grid_sf)


# Setting Thresholds ------------------------------------------------------

grid_sf <- grid_sf %>% dplyr::mutate(agg_yield_ratio_thresh = ifelse(yield_ach_ratio <5, 1,0)) # Aggregate Yield Achievement Ratio

grid_sf <- grid_sf %>% dplyr::mutate(forest_loss_thresh = ifelse(forest_loss >0, 1,0)) # Forest Loss

grid_sf <- grid_sf %>% dplyr::mutate(ntl_nogf_thresh = ifelse(nogf_change_in_ntl_2021_2017<0, 1,0)) # Nightlights Non-Oil Activity

grid_sf <- grid_sf %>% dplyr::mutate(ntl_gf_thresh = ifelse(gf_change_in_ntl_2021_2017<0, 1,0)) #Nightlights Oil Activity

grid_sf <- grid_sf %>% dplyr::mutate(conflict_thresh = ifelse(tot_5yrs_acled_indicator > 0, 1,0)) # Conflict

grid_sf <- grid_sf%>% dplyr::mutate(tt_health_thresh = ifelse(min_tt_health >60,1,0),
                tt_educ_thresh = ifelse(min_tt_educ >60,1,0),
                tt_markets_thresh = ifelse(min_tt_markets>60,1,0)) #Travel Time






# Count the number of vulnerability thresholds ----------------------------
grid_sf <- grid_sf %>%
  rowwise() %>%
  mutate(max_dim_gis = sum(!is.na(c(agg_yield_ratio_thresh, forest_loss_thresh,
                                    ntl_nogf_thresh, ntl_gf_thresh, conflict_thresh,
                                    tt_health_thresh,tt_educ_thresh, tt_markets_thresh)), na.rm = TRUE)) %>%
  ungroup()

grid_sf <- grid_sf %>%
  rowwise() %>%
  dplyr::mutate(vul_dim_gis = sum(c(agg_yield_ratio_thresh, forest_loss_thresh,
                                    ntl_nogf_thresh, ntl_gf_thresh, conflict_thresh,
                                    tt_health_thresh,tt_educ_thresh, tt_markets_thresh), na.rm = T)) %>%
  ungroup()





# Create share of vulnerability (GIS + HH) --------------------------------

grid_sf<- grid_sf%>%
  rowwise() %>%
  dplyr::mutate(
    num_share = sum(c(exp_dim,vul_dim_gis),na.rm = T),
    denom_share = sum(c(max_dim,max_dim_gis),na.rm = T),
    vul_share = num_share/denom_share
  ) %>%
  ungroup()





# Define vulnerability threshold ------------------------------------------
grid_sf<- grid_sf%>%
  dplyr::mutate(vul_thresh_region = summary(grid_sf$vul_share)[5]) %>%
  group_by(ISO_A2) %>%
  dplyr::mutate(vul_thresh_country = summary(vul_share)[5]) %>%
  ungroup()




# Export ------------------------------------------------------------------
saveRDS(grid_sf, file.path(final_replication, "grid_vul_10km_final.Rds"))



